<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#667eea">
    <title>Grocery List</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiR3JvY2VyeSBMaXN0Iiwic2hvcnRfbmFtZSI6Ikdyb2NlcnkiLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2Y1ZjVmMCIsInRoZW1lX2NvbG9yIjoiIzY2N2VlYSIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSXhNRGdpSUdobGFXZG9kRDBpTVRBNElqNDhjbVZqZENCbWFXeHNQU0lqTmpZM1pXVmhJaUI0UFNJd0lpQjVQU0l3SWlCM2FXUjBhRDBpTVRBNElpQm9aV2xuYUhROUlqRXdPQ0l2UGp3dmMzWm5QZz09Iiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(to bottom, #f5f5f0 0%, #e8e8e0 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle, #fff 1px, transparent 1px),
                radial-gradient(circle, #fff 1px, transparent 1px);
            background-size: 50px 50px, 80px 80px;
            background-position: 0 0, 40px 40px;
            opacity: 0.3;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 28px;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
        }

        /* Setup Screen Styles */
        .setup-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .setup-container h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 22px;
        }

        .setup-container p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .setup-container ol {
            line-height: 1.8;
            color: #555;
            padding-left: 20px;
            margin-bottom: 20px;
        }

        .setup-container li {
            margin-bottom: 12px;
        }

        .setup-container input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin: 10px 0;
        }

        .setup-container label {
            font-weight: bold;
            color: #2c3e50;
            display: block;
            margin-top: 20px;
            margin-bottom: 5px;
        }

        .setup-container code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            color: #e74c3c;
        }

        .setup-container .btn {
            width: 100%;
            margin-top: 20px;
        }

        .setup-container a {
            color: #667eea;
            text-decoration: none;
        }

        .setup-container a:hover {
            text-decoration: underline;
        }

        .voice-container {
            text-align: center;
            margin-top: 60px;
        }

        .status-text {
            font-size: 18px;
            color: #555;
            margin-bottom: 30px;
            min-height: 150px;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.6;
        }

        .mic-button {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 40px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mic-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
        }

        .mic-button:active {
            transform: scale(0.95);
        }

        .mic-button.listening {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            min-width: 120px;
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #f8f9ff;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .sync-status {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            color: #27ae60;
            font-style: italic;
        }

        .sync-status.error {
            color: #e74c3c;
        }

        .sync-status.syncing {
            color: #3498db;
        }

        .permission-banner {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .permission-banner.show {
            display: block;
        }

        .permission-banner h3 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .permission-banner p {
            color: #856404;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .permission-banner button {
            background: #ffc107;
            color: #856404;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
        }

        .permission-banner button:hover {
            background: #ffca2c;
        }

        .quick-items {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        .quick-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .quick-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            cursor: pointer;
        }

        .quick-item label {
            font-size: 18px;
            color: #2c3e50;
            cursor: pointer;
            flex-grow: 1;
        }

        .current-list {
            margin-top: 20px;
        }

        .list-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .list-item span {
            font-size: 18px;
            color: #2c3e50;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s ease;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .manual-add {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .manual-add input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .manual-add button {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            font-size: 16px;
        }

        .history-list {
            margin-top: 20px;
        }

        .history-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .history-item h3 {
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .history-item p {
            color: #777;
            font-size: 14px;
            margin-bottom: 6px;
        }

        .history-item ul {
            margin-top: 10px;
            padding-left: 20px;
            color: #555;
        }

        .nav-dots {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            border: 2px solid #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dot.active {
            background: #667eea;
            transform: scale(1.3);
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                bottom: 50px;
                opacity: 0;
            }
            to {
                bottom: 100px;
                opacity: 1;
            }
        }

        .reset-settings {
            text-align: center;
            margin-top: 20px;
        }

        .reset-settings button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Setup Screen -->
        <div id="setup-screen" class="screen active">
            <h1>üõí Grocery List Setup</h1>
            <div class="setup-container">
                <h2>Welcome!</h2>
                <p>To sync your grocery list between devices, you'll need to set up Google Drive. This is a <strong>one-time setup</strong> - you'll never need to do this again!</p>
                
                <h2>Quick Setup (5 minutes)</h2>
                <ol>
                    <li>Go to <a href="https://console.cloud.google.com" target="_blank">Google Cloud Console</a></li>
                    <li>Click "Select a project" ‚Üí "New Project"</li>
                    <li>Name it "Grocery List" and click "Create"</li>
                    <li>Select your new project</li>
                    <li>Search for "Google Drive API" and enable it</li>
                    <li>Go to "Credentials" ‚Üí "Create Credentials" ‚Üí "API Key"</li>
                    <li>Copy the API key and paste below</li>
                    <li>Click "Restrict Key" ‚Üí Select "Google Drive API" only</li>
                </ol>
                
                <label for="api-key-input">Google API Key:</label>
                <input type="text" id="api-key-input" placeholder="Paste your API Key here">
                
                <h2 style="margin-top: 30px;">Create Shared Folder</h2>
                <ol>
                    <li>Go to <a href="https://drive.google.com" target="_blank">Google Drive</a></li>
                    <li>Create a new folder called "Grocery Lists"</li>
                    <li>Right-click ‚Üí Share ‚Üí Add your spouse's email</li>
                    <li>Give them "Editor" access</li>
                    <li>Click "Copy link" and paste below</li>
                </ol>
                
                <label for="folder-link-input">Google Drive Folder Link:</label>
                <input type="text" id="folder-link-input" placeholder="Paste your folder link here">
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="completeSetup()">Save & Start Using App</button>
                </div>

                <p style="margin-top: 20px; font-size: 14px; color: #777;">
                    <strong>Note:</strong> Your credentials are stored securely on your device only. They are never shared with anyone.
                </p>
            </div>
        </div>

        <!-- Permission Banner -->
        <div class="permission-banner" id="permission-banner">
            <h3>üé§ Microphone Access Needed</h3>
            <p>To use voice input, this app needs permission to access your microphone. Click the button below to grant permission.</p>
            <button onclick="requestMicrophonePermission()">Grant Microphone Access</button>
        </div>

        <!-- Main Voice Input Screen -->
        <div id="voice-screen" class="screen">
            <h1>üõí Grocery List</h1>
            <div class="voice-container">
                <div class="status-text" id="status-text">
                    Tap the microphone and say your items.<br>
                    Say "Add" between items.<br>
                    Example: "Eggs. Add. Milk. Add. Bread."
                </div>
                <button class="mic-button" id="mic-button" onclick="toggleVoiceRecognition()">
                    üé§
                </button>
            </div>
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="viewCurrentList()">View List (<span id="item-count">0</span>)</button>
                <button class="btn btn-success" onclick="emailList()">üìß Email List</button>
            </div>
            <div class="sync-status" id="sync-status">Connecting to Drive...</div>
            <div class="reset-settings">
                <button onclick="resetSettings()">‚öôÔ∏è Reset Settings</button>
            </div>
        </div>

        <!-- Quick Add Screen -->
        <div id="quick-screen" class="screen">
            <h1>Quick Add Items</h1>
            <div class="quick-items" id="quick-items"></div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="addQuickItems()">Add Selected Items</button>
                <button class="btn btn-secondary" onclick="showScreen('voice-screen')">Back</button>
            </div>
        </div>

        <!-- Edit List Screen -->
        <div id="edit-screen" class="screen">
            <h1>Current List</h1>
            <div class="manual-add">
                <input type="text" id="manual-input" placeholder="Type item name...">
                <button onclick="addManualItem()">Add</button>
            </div>
            <div class="current-list" id="current-list"></div>
            <div class="action-buttons">
                <button class="btn btn-success" onclick="emailList()">üìß Email List</button>
                <button class="btn btn-danger" onclick="resetList()">Reset List</button>
                <button class="btn btn-secondary" onclick="showHistory()">View History</button>
                <button class="btn btn-secondary" onclick="showScreen('voice-screen')">Back</button>
            </div>
        </div>

        <!-- History Screen -->
        <div id="history-screen" class="screen">
            <h1>Past Lists</h1>
            <div class="history-list" id="history-list"></div>
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="showScreen('edit-screen')">Back</button>
            </div>
        </div>
    </div>

    <!-- Navigation dots -->
    <div class="nav-dots" style="display: none;" id="nav-dots">
        <div class="dot active" onclick="showScreen('voice-screen')"></div>
        <div class="dot" onclick="showScreen('quick-screen')"></div>
        <div class="dot" onclick="showScreen('edit-screen')"></div>
    </div>

    <script>
        // Configuration stored in localStorage
        let CONFIG = {
            apiKey: '',
            folderId: ''
        };

        // State
        let groceryList = [];
        let isListening = false;
        let recognition = null;
        let currentTranscript = '';
        let listFileId = null;
        let historyFileId = null;
        let microphonePermissionGranted = false;

        // Common grocery items for quick add
        const quickAddItems = [
            'Eggs', 'Milk', 'Bread', 'Butter', 'Cheese',
            'Chicken', 'Ground Beef', 'Bananas', 'Apples', 'Oranges',
            'Lettuce', 'Tomatoes', 'Onions', 'Potatoes', 'Carrots',
            'Rice', 'Pasta', 'Cereal', 'Coffee', 'Tea'
        ];

        // Initialize app
        async function init() {
            console.log('Initializing app...');
            loadConfig();
            
            if (CONFIG.apiKey && CONFIG.folderId) {
                // Config exists, show main app
                document.getElementById('setup-screen').classList.remove('active');
                document.getElementById('voice-screen').classList.add('active');
                document.getElementById('nav-dots').style.display = 'flex';
                
                checkMicrophonePermission();
                setupVoiceRecognition();
                generateQuickAddItems();
                updateNavigation();
                await initializeGoogleDrive();
            } else {
                // Show setup screen
                document.getElementById('setup-screen').classList.add('active');
                document.getElementById('nav-dots').style.display = 'none';
            }
        }

        function loadConfig() {
            const saved = localStorage.getItem('groceryConfig');
            if (saved) {
                CONFIG = JSON.parse(saved);
            }
        }

        function saveConfig() {
            localStorage.setItem('groceryConfig', JSON.stringify(CONFIG));
        }

        function completeSetup() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            const folderLink = document.getElementById('folder-link-input').value.trim();
            
            if (!apiKey || !folderLink) {
                alert('Please fill in both fields');
                return;
            }

            // Extract folder ID from link
            const folderIdMatch = folderLink.match(/folders\/([a-zA-Z0-9-_]+)/);
            if (!folderIdMatch) {
                alert('Invalid folder link. Please check and try again.');
                return;
            }

            CONFIG.apiKey = apiKey;
            CONFIG.folderId = folderIdMatch[1];
            saveConfig();

            showToast('Setup complete! Loading app...');
            setTimeout(() => {
                location.reload();
            }, 1500);
        }

        function resetSettings() {
            if (confirm('This will clear your Google Drive credentials and you\'ll need to set up again. Continue?')) {
                localStorage.removeItem('groceryConfig');
                location.reload();
            }
        }

        // Check microphone permission status
        async function checkMicrophonePermission() {
            try {
                if (navigator.permissions) {
                    const result = await navigator.permissions.query({ name: 'microphone' });
                    console.log('Microphone permission:', result.state);
                    
                    if (result.state === 'granted') {
                        microphonePermissionGranted = true;
                        document.getElementById('permission-banner').classList.remove('show');
                    } else {
                        document.getElementById('permission-banner').classList.add('show');
                    }
                } else {
                    document.getElementById('permission-banner').classList.add('show');
                }
            } catch (error) {
                console.error('Error checking microphone permission:', error);
                document.getElementById('permission-banner').classList.add('show');
            }
        }

        // Explicitly request microphone permission
        async function requestMicrophonePermission() {
            try {
                console.log('Requesting microphone permission...');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log('Permission granted!');
                
                stream.getTracks().forEach(track => track.stop());
                
                microphonePermissionGranted = true;
                document.getElementById('permission-banner').classList.remove('show');
                showToast('Microphone access granted! You can now use voice input.');
            } catch (error) {
                console.error('Permission denied:', error);
                alert('Microphone access is required for voice input.\n\nTo enable:\n1. Go to your browser settings\n2. Find this website\n3. Allow microphone access\n4. Reload the page');
            }
        }

        // Google Drive integration
        async function initializeGoogleDrive() {
            try {
                updateSyncStatus('Connecting to Drive...', 'syncing');
                
                listFileId = await findOrCreateFile('grocery-list.json', {items: []});
                historyFileId = await findOrCreateFile('grocery-history.json', {lists: []});
                
                await loadGroceryList();
                updateSyncStatus('Synced with Drive', 'success');
            } catch (error) {
                console.error('Google Drive initialization error:', error);
                updateSyncStatus('Sync error - working offline', 'error');
                showToast('Could not connect to Google Drive. Working offline.');
            }
        }

        async function findOrCreateFile(fileName, defaultContent) {
            try {
                const searchUrl = `https://www.googleapis.com/drive/v3/files?q=name='${fileName}' and '${CONFIG.folderId}' in parents and trashed=false&key=${CONFIG.apiKey}`;
                
                const searchResponse = await fetch(searchUrl);
                const searchData = await searchResponse.json();

                if (searchData.files && searchData.files.length > 0) {
                    return searchData.files[0].id;
                }

                return await createFile(fileName, defaultContent);
            } catch (error) {
                console.error('Error finding/creating file:', error);
                throw error;
            }
        }

        async function createFile(fileName, defaultContent) {
            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const closeDelimiter = "\r\n--" + boundary + "--";

            const metadata = {
                name: fileName,
                mimeType: 'application/json',
                parents: [CONFIG.folderId]
            };

            const multipartRequestBody =
                delimiter +
                'Content-Type: application/json\r\n\r\n' +
                JSON.stringify(metadata) +
                delimiter +
                'Content-Type: application/json\r\n\r\n' +
                JSON.stringify(defaultContent) +
                closeDelimiter;

            const createResponse = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&key=' + CONFIG.apiKey, {
                method: 'POST',
                headers: {
                    'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                },
                body: multipartRequestBody
            });

            const result = await createResponse.json();
            return result.id;
        }

        async function loadGroceryList() {
            if (!listFileId) return;

            try {
                updateSyncStatus('Loading list...', 'syncing');
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${listFileId}?alt=media&key=${CONFIG.apiKey}`);
                const data = await response.json();
                groceryList = data.items || [];
                updateListDisplay();
                updateItemCount();
                updateSyncStatus('Synced with Drive', 'success');
            } catch (error) {
                console.error('Error loading list:', error);
                groceryList = [];
                updateSyncStatus('Sync error - working offline', 'error');
            }
        }

        async function saveGroceryList() {
            if (!listFileId) return;

            try {
                updateSyncStatus('Saving...', 'syncing');
                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\r\n";
                const closeDelimiter = "\r\n--" + boundary + "--";

                const multipartRequestBody =
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify({items: groceryList}) +
                    closeDelimiter;

                await fetch(`https://www.googleapis.com/upload/drive/v3/files/${listFileId}?uploadType=multipart&key=${CONFIG.apiKey}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                    },
                    body: multipartRequestBody
                });

                updateItemCount();
                updateSyncStatus('Synced with Drive', 'success');
            } catch (error) {
                console.error('Error saving list:', error);
                updateSyncStatus('Sync error - changes saved locally', 'error');
            }
        }

        function updateSyncStatus(message, status) {
            const syncStatus = document.getElementById('sync-status');
            if (syncStatus) {
                syncStatus.textContent = message;
                syncStatus.className = 'sync-status ' + status;
            }
        }

        // Voice recognition
        function setupVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.error('Speech recognition not supported');
                showToast('Voice recognition not supported in this browser');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                if (finalTranscript) {
                    currentTranscript += finalTranscript;
                    processVoiceInput(currentTranscript);
                }

                document.getElementById('status-text').textContent = 
                    interimTranscript || currentTranscript || 'Listening...';
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                
                if (event.error === 'not-allowed') {
                    stopListening();
                    document.getElementById('permission-banner').classList.add('show');
                    showToast('Microphone access denied. Please grant permission above.');
                } else if (event.error === 'no-speech') {
                    if (isListening) {
                        recognition.start();
                    }
                } else {
                    stopListening();
                    showToast('Voice recognition error: ' + event.error);
                }
            };

            recognition.onend = () => {
                if (isListening) {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error('Error restarting recognition:', e);
                        stopListening();
                    }
                }
            };
        }

        function toggleVoiceRecognition() {
            if (!microphonePermissionGranted) {
                requestMicrophonePermission();
                return;
            }

            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        function startListening() {
            if (!recognition) {
                showToast('Voice recognition not available');
                return;
            }

            isListening = true;
            currentTranscript = '';
            document.getElementById('mic-button').classList.add('listening');
            document.getElementById('status-text').textContent = 'Listening...';
            
            try {
                recognition.start();
            } catch (error) {
                console.error('Error starting recognition:', error);
                if (error.name === 'NotAllowedError') {
                    document.getElementById('permission-banner').classList.add('show');
                    showToast('Please grant microphone permission');
                }
                stopListening();
            }
        }

        function stopListening() {
            isListening = false;
            if (recognition) {
                recognition.stop();
            }
            document.getElementById('mic-button').classList.remove('listening');
            document.getElementById('status-text').textContent = 
                'Tap the microphone and say your items.\nSay "Add" between items.\nExample: "Eggs. Add. Milk. Add. Bread."';
        }

        function processVoiceInput(transcript) {
            const items = transcript.split(/\s+add\s+/i).map(item => 
                item.trim().replace(/[.,!?]/g, '')
            ).filter(item => item.length > 0);

            items.forEach(item => {
                addItemToList(item);
            });

            if (items.length > 0) {
                currentTranscript = '';
            }
        }

        // List management (same as before)
        function addItemToList(itemName) {
            if (!itemName || itemName.length === 0) return;

            const normalizedNew = itemName.toLowerCase().trim();
            
            const exactDuplicate = groceryList.some(item => 
                item.toLowerCase() === normalizedNew
            );

            if (exactDuplicate) {
                showToast(`"${itemName}" is already on the list`);
                return;
            }

            const baseWords = normalizedNew.split(' ');
            const hasSimilar = groceryList.some(existingItem => {
                const existingBase = existingItem.toLowerCase().split(' ');
                return baseWords.some(word => 
                    word.length > 3 && existingBase.some(existing => 
                        existing.includes(word) || word.includes(existing)
                    )
                );
            });

            if (hasSimilar) {
                const significantDifference = baseWords.some(word => 
                    word.length > 3 && !groceryList.some(item => 
                        item.toLowerCase().includes(word)
                    )
                );

                if (!significantDifference) {
                    showToast(`Similar item already on the list`);
                    return;
                }
            }

            groceryList.push(itemName);
            saveGroceryList();
            showToast(`Added: ${itemName}`);
            updateListDisplay();
        }

        function removeItemFromList(index) {
            const item = groceryList[index];
            groceryList.splice(index, 1);
            saveGroceryList();
            showToast(`Removed: ${item}`);
            updateListDisplay();
        }

        function updateListDisplay() {
            const listContainer = document.getElementById('current-list');
            
            if (groceryList.length === 0) {
                listContainer.innerHTML = '<div class="empty-state">Your list is empty.<br>Add items using voice or quick add!</div>';
                return;
            }

            listContainer.innerHTML = groceryList.map((item, index) => `
                <div class="list-item">
                    <span>${item}</span>
                    <button class="delete-btn" onclick="removeItemFromList(${index})">Remove</button>
                </div>
            `).join('');
        }

        function updateItemCount() {
            const countEl = document.getElementById('item-count');
            if (countEl) {
                countEl.textContent = groceryList.length;
            }
        }

        // Quick add
        function generateQuickAddItems() {
            const container = document.getElementById('quick-items');
            container.innerHTML = quickAddItems.map((item, index) => `
                <div class="quick-item">
                    <input type="checkbox" id="quick-${index}" value="${item}">
                    <label for="quick-${index}">${item}</label>
                </div>
            `).join('');
        }

        function addQuickItems() {
            let addedCount = 0;
            quickAddItems.forEach((item, index) => {
                const checkbox = document.getElementById(`quick-${index}`);
                if (checkbox && checkbox.checked) {
                    addItemToList(item);
                    checkbox.checked = false;
                    addedCount++;
                }
            });

            if (addedCount > 0) {
                showToast(`Added ${addedCount} item(s)`);
            } else {
                showToast('No items selected');
            }
        }

        function addManualItem() {
            const input = document.getElementById('manual-input');
            const itemName = input.value.trim();
            
            if (itemName) {
                addItemToList(itemName);
                input.value = '';
            }
        }

        // Email functionality
        function emailList() {
            if (groceryList.length === 0) {
                showToast('List is empty!');
                return;
            }

            const listText = groceryList.map((item, i) => `${i + 1}. ${item}`).join('\n');
            const subject = `Grocery List - ${new Date().toLocaleDateString()}`;
            const body = `Here's your grocery list:\n\n${listText}\n\nGenerated by Grocery List App`;
            
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoLink;

            saveToHistory('emailed');
        }

        // Reset list
        function resetList() {
            if (groceryList.length === 0) {
                showToast('List is already empty!');
                return;
            }

            if (confirm('Are you sure you want to reset the list? This will clear all items.')) {
                saveToHistory('reset');
                groceryList = [];
                saveGroceryList();
                updateListDisplay();
                showToast('List reset!');
            }
        }

        // History
        async function saveToHistory(action) {
            if (!historyFileId || groceryList.length === 0) return;

            try {
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${historyFileId}?alt=media&key=${CONFIG.apiKey}`);
                const data = await response.json();
                const history = data.lists || [];

                history.unshift({
                    date: new Date().toISOString(),
                    action: action,
                    items: [...groceryList]
                });

                if (history.length > 20) {
                    history.length = 20;
                }

                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\r\n";
                const closeDelimiter = "\r\n--" + boundary + "--";

                const multipartRequestBody =
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify({lists: history}) +
                    closeDelimiter;

                await fetch(`https://www.googleapis.com/upload/drive/v3/files/${historyFileId}?uploadType=multipart&key=${CONFIG.apiKey}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                    },
                    body: multipartRequestBody
                });
            } catch (error) {
                console.error('Error saving history:', error);
            }
        }

        async function showHistory() {
            showScreen('history-screen');

            if (!historyFileId) {
                document.getElementById('history-list').innerHTML = 
                    '<div class="empty-state">No history available</div>';
                return;
            }

            try {
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${historyFileId}?alt=media&key=${CONFIG.apiKey}`);
                const data = await response.json();
                const history = data.lists || [];

                if (history.length === 0) {
                    document.getElementById('history-list').innerHTML = 
                        '<div class="empty-state">No past lists yet</div>';
                    return;
                }

                document.getElementById('history-list').innerHTML = history.map(list => {
                    const date = new Date(list.date).toLocaleString();
                    return `
                        <div class="history-item">
                            <h3>${list.action === 'emailed' ? 'üìß' : 'üîÑ'} ${list.action === 'emailed' ? 'Emailed' : 'Reset'}</h3>
                            <p><strong>Date:</strong> ${date}</p>
                            <p><strong>Items (${list.items.length}):</strong></p>
                            <ul>
                                ${list.items.slice(0, 10).map(item => `<li>${item}</li>`).join('')}
                                ${list.items.length > 10 ? `<li><em>...and ${list.items.length - 10} more</em></li>` : ''}
                            </ul>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading history:', error);
                document.getElementById('history-list').innerHTML = 
                    '<div class="empty-state">Error loading history</div>';
            }
        }

        // Screen navigation
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            updateNavigation();

            if (screenId === 'edit-screen') {
                updateListDisplay();
            }
        }

        function updateNavigation() {
            const dots = document.querySelectorAll('.dot');
            dots.forEach(dot => dot.classList.remove('active'));

            const activeScreen = document.querySelector('.screen.active');
            if (activeScreen) {
                const screenId = activeScreen.id;
                const screenIndex = ['voice-screen', 'quick-screen', 'edit-screen'].indexOf(screenId);
                if (screenIndex >= 0 && dots[screenIndex]) {
                    dots[screenIndex].classList.add('active');
                }
            }
        }

        function viewCurrentList() {
            showScreen('edit-screen');
        }

        // Toast notifications
        function showToast(message) {
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Swipe navigation
        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;

            if (Math.abs(diff) < swipeThreshold) return;

            const activeScreen = document.querySelector('.screen.active').id;
            
            if (diff > 0) {
                if (activeScreen === 'voice-screen') showScreen('quick-screen');
                else if (activeScreen === 'quick-screen') showScreen('edit-screen');
            } else {
                if (activeScreen === 'edit-screen') showScreen('quick-screen');
                else if (activeScreen === 'quick-screen') showScreen('voice-screen');
            }
        }

        // Handle Enter key in manual input
        document.addEventListener('DOMContentLoaded', () => {
            const manualInput = document.getElementById('manual-input');
            if (manualInput) {
                manualInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        addManualItem();
                    }
                });
            }
        });

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>
