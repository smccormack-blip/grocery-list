<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Grocery List - Shopping Man Edition</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(to bottom, #f5f5f0, #e8e8e0);
            min-height: 100vh;
        }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; font-size: 28px; }
        .status-text {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 60px 0 30px;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.6;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .mic-button {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 40px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(102,126,234,0.4);
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mic-button.listening {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .action-buttons { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .btn {
            flex: 1;
            min-width: 120px;
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
        }
        .btn-secondary { background: white; color: #667eea; border: 2px solid #667eea; }
        .btn-share { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .permission-banner {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        .permission-banner.show { display: block; }
        .permission-banner h3 { color: #856404; margin-bottom: 10px; }
        .permission-banner p { color: #856404; margin-bottom: 10px; }
        .permission-banner button {
            background: #ffc107;
            color: #856404;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }
        .quick-items { display: grid; gap: 12px; margin-top: 20px; }
        .quick-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        .quick-item input { width: 24px; height: 24px; margin-right: 15px; cursor: pointer; }
        .quick-item label { font-size: 18px; color: #2c3e50; cursor: pointer; flex-grow: 1; }
        .list-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .list-item span { font-size: 18px; color: #2c3e50; }
        .list-item.deleted { opacity: 0.6; }
        .list-item.deleted span { text-decoration: line-through; color: #999; }
        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }
        .manual-add { display: flex; gap: 10px; margin-bottom: 20px; }
        .manual-add input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        .manual-add button {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .empty-state { text-align: center; color: #999; padding: 40px 20px; }
        .history-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .history-item h3 { color: #2c3e50; font-size: 16px; margin-bottom: 8px; }
        .history-item p { color: #777; font-size: 14px; margin-bottom: 6px; }
        .history-item ul { margin-top: 10px; padding-left: 20px; color: #555; }
        
        /* Shopping Man Screen */
        .shopping-screen {
            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), 
                        url('Shopping_Man.jpg') center/cover;
            border-radius: 15px;
            padding: 20px;
            min-height: 80vh;
        }
        .shopping-screen h1 {
            color: #ffd700;
            text-shadow: 3px 3px 6px #000, 0 0 15px #ff0000, 0 0 25px #ff0000;
            font-size: 28px;
            margin-bottom: 15px;
            animation: heroGlow 2s infinite;
        }
        @keyframes heroGlow {
            0%, 100% { text-shadow: 3px 3px 6px #000, 0 0 15px #ff0000; }
            50% { text-shadow: 3px 3px 6px #000, 0 0 25px #ff0000, 0 0 35px #ff6600; }
        }
        .progress-bar {
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            height: 35px;
            margin: 15px 0 25px;
            overflow: hidden;
            border: 2px solid rgba(255,215,0,0.5);
        }
        .progress-fill {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 0 10px rgba(76,175,80,0.8);
        }
        .shopping-item {
            background: rgba(255,255,255,0.95);
            padding: 15px;
            margin: 12px 0;
            border-radius: 12px;
            display: flex;
            align-items: center;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .shopping-item.checked {
            background: rgba(76,175,80,0.4);
            transform: scale(0.98);
        }
        .shopping-item.checked span {
            text-decoration: line-through;
            color: #4CAF50;
            font-weight: bold;
        }
        .shopping-item input[type="checkbox"] {
            width: 32px;
            height: 32px;
            margin-right: 15px;
            cursor: pointer;
            accent-color: #4CAF50;
        }
        .shopping-item span {
            font-size: 20px;
            color: #2c3e50;
            flex-grow: 1;
            font-weight: 500;
        }
        .fulfill-button {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 15px;
            font-size: 22px;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(255,107,107,0.5);
            animation: pulse-glow 2s infinite;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 6px 20px rgba(255,107,107,0.5); transform: scale(1); }
            50% { box-shadow: 0 10px 35px rgba(255,107,107,0.9); transform: scale(1.02); }
        }
        .fulfill-button:active { transform: scale(0.95); }
        
        .nav-dots {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            border: 2px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }
        .dot.active { background: #667eea; transform: scale(1.3); }
        .dot:last-child {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            background: rgba(255,215,0,0.3);
            border-color: #ffd700;
        }
        .dot:last-child.active {
            background: #ffd700;
            box-shadow: 0 0 15px rgba(255,215,0,0.8);
        }
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideUp 0.3s;
            max-width: 90%;
            text-align: center;
        }
        @keyframes slideUp { from { bottom: 50px; opacity: 0; } to { bottom: 100px; opacity: 1; } }
        
        /* Flying Shopping Man Animation */
        .flying-hero {
            position: fixed;
            bottom: 120px;
            left: -100px;
            width: 80px;
            height: 80px;
            font-size: 60px;
            animation: fly 15s linear infinite;
            z-index: 50;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }
        @keyframes fly {
            0% { left: -100px; }
            50% { left: 100%; }
            50.01% { left: 100%; transform: scaleX(-1); }
            100% { left: -100px; transform: scaleX(-1); }
        }
        .follower {
            position: fixed;
            bottom: 120px;
            font-size: 40px;
            animation: follow 15s linear infinite;
            z-index: 49;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }
        .follower:nth-child(2) { animation-delay: 1s; bottom: 145px; }
        .follower:nth-child(3) { animation-delay: 2s; bottom: 95px; }
        .follower:nth-child(4) { animation-delay: 3s; bottom: 130px; }
        @keyframes follow {
            0% { left: -120px; opacity: 0; }
            10% { opacity: 1; }
            40% { opacity: 1; }
            50% { left: calc(100% - 50px); opacity: 0; }
            50.01% { left: calc(100% - 50px); transform: scaleX(-1); opacity: 0; }
            60% { opacity: 1; }
            90% { opacity: 1; }
            100% { left: -120px; transform: scaleX(-1); opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="permission-banner" id="permission-banner">
            <h3>üé§ Microphone Access Needed</h3>
            <p>To use voice input, this app needs permission to access your microphone.</p>
            <button onclick="requestMicrophonePermission()">Grant Microphone Access</button>
        </div>

        <div id="voice-screen" class="screen active">
            <h1>üõí Grocery List</h1>
            <div class="status-text" id="status-text">
                Tap the microphone and say your items. Pause between items. Once you are finished adding items, tap the microphone again to turn it off.<br><br>
                Swipe right to see quick select screens, list and SHOPPING MAN MODE!
            </div>
            <button class="mic-button" id="mic-button" onclick="toggleVoice()">üé§</button>
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="showScreen('edit-screen')">
                    View List (<span id="item-count">0</span>)
                </button>
                <button class="btn btn-share" onclick="shareList()">üì± Share List</button>
            </div>
            
            <!-- Flying Shopping Man and Friends -->
            <div class="flying-hero">ü¶∏‚Äç‚ôÇÔ∏è</div>
            <div class="follower">ü¶Ñ</div>
            <div class="follower">üê±</div>
            <div class="follower">ü¶Ñ</div>
        </div>

        <div id="quick-screen" class="screen">
            <h1>Quick Add Items</h1>
            <div class="quick-items" id="quick-items"></div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="addQuickItems()">Add Selected</button>
                <button class="btn btn-secondary" onclick="showScreen('voice-screen')">Back</button>
            </div>
        </div>

        <div id="edit-screen" class="screen">
            <h1>Current List</h1>
            <div class="manual-add">
                <input type="text" id="manual-input" placeholder="Type item name...">
                <button onclick="addManualItem()">Add</button>
            </div>
            <div id="current-list"></div>
            <div class="action-buttons">
                <button class="btn btn-share" onclick="shareList()">üì± Share</button>
                <button class="btn btn-success" onclick="emailList()">üìß Email</button>
                <button class="btn btn-danger" onclick="resetList()">Reset</button>
                <button class="btn btn-secondary" onclick="showScreen('history-screen')">History</button>
                <button class="btn btn-secondary" onclick="showScreen('voice-screen')">Back</button>
            </div>
        </div>

        <div id="history-screen" class="screen">
            <h1>Past Lists</h1>
            <div id="history-list"></div>
            <div class="action-buttons">
                <button class="btn btn-danger" onclick="clearOldHistory()">Clear Old History (8+ weeks)</button>
                <button class="btn btn-secondary" onclick="showScreen('edit-screen')">Back</button>
            </div>
        </div>

        <div id="shopping-screen" class="screen">
            <div class="shopping-screen">
                <h1>ü¶∏‚Äç‚ôÇÔ∏è SHOPPING MAN MODE ü¶∏‚Äç‚ôÇÔ∏è</h1>
                <div class="progress-bar">
                    <div class="progress-fill" id="shopping-progress" style="width: 0%">0/0</div>
                </div>
                <div id="shopping-list"></div>
                <button class="fulfill-button" onclick="fulfillFoodDuties()">
                    ü¶∏‚Äç‚ôÇÔ∏è FULFILLED FOOD DUTIES! ü¶∏‚Äç‚ôÇÔ∏è
                </button>
                <div class="action-buttons" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="showScreen('voice-screen')">Back</button>
                </div>
            </div>
        </div>
    </div>

    <div class="nav-dots">
        <div class="dot active" onclick="showScreen('voice-screen')"></div>
        <div class="dot" onclick="showScreen('quick-screen')"></div>
        <div class="dot" onclick="showScreen('edit-screen')"></div>
        <div class="dot" onclick="showScreen('shopping-screen')">ü¶∏</div>
    </div>

    <script>
        let groceryList = [];
        let deletedItems = [];
        let shoppingChecked = [];
        let itemFrequency = {};
        let history = [];
        let isListening = false;
        let recognition = null;
        let currentTranscript = '';
        let micPermitted = false;

        const defaultQuickItems = ['Eggs','Milk','Bread','Butter','Cheese','Chicken','Bananas','Apples','Lettuce','Tomatoes','Onions','Potatoes','Rice','Pasta','Coffee'];

        // Sound effects
        const sounds = {
            yum: () => {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance('Yum!');
                    utterance.rate = 1.5;
                    utterance.pitch = 1.2;
                    utterance.volume = 0.8;
                    speechSynthesis.speak(utterance);
                } else {
                    // Fallback beep
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.frequency.value = 800;
                    gain.gain.setValueAtTime(0.3, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                    osc.start(ctx.currentTime);
                    osc.stop(ctx.currentTime + 0.1);
                }
            },
            yuck: () => {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance('Yuck!');
                    utterance.rate = 1.2;
                    utterance.pitch = 0.8;
                    utterance.volume = 0.8;
                    speechSynthesis.speak(utterance);
                } else {
                    // Fallback beep
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.frequency.value = 200;
                    gain.gain.setValueAtTime(0.3, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                    osc.start(ctx.currentTime);
                    osc.stop(ctx.currentTime + 0.2);
                }
            },
            swoosh: () => {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(600, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.3);
            }
        };

        function playSound(type) {
            try { sounds[type](); } catch(e) { console.log('Sound error:', e); }
        }

        function init() {
            loadData();
            checkMicPermission();
            setupVoiceRecognition();
            updateUI();
            handleIncomingShare();
            handleShoppingCompletion();
        }

        function loadData() {
            groceryList = JSON.parse(localStorage.getItem('groceryList') || '[]');
            deletedItems = JSON.parse(localStorage.getItem('deletedItems') || '[]');
            itemFrequency = JSON.parse(localStorage.getItem('itemFrequency') || '{}');
            history = JSON.parse(localStorage.getItem('groceryHistory') || '[]');
            shoppingChecked = JSON.parse(localStorage.getItem('shoppingChecked') || '[]');
        }

        function saveData() {
            localStorage.setItem('groceryList', JSON.stringify(groceryList));
            localStorage.setItem('deletedItems', JSON.stringify(deletedItems));
            localStorage.setItem('itemFrequency', JSON.stringify(itemFrequency));
            localStorage.setItem('groceryHistory', JSON.stringify(history));
            localStorage.setItem('shoppingChecked', JSON.stringify(shoppingChecked));
        }

        function handleIncomingShare() {
            const params = new URLSearchParams(window.location.search);
            const shared = params.get('items');
            const sharedDeleted = params.get('deleted');
            
            if (shared) {
                try {
                    const incomingItems = JSON.parse(decodeURIComponent(shared));
                    const incomingDeleted = sharedDeleted ? JSON.parse(decodeURIComponent(sharedDeleted)) : [];
                    
                    let added = 0;
                    incomingItems.forEach(item => {
                        const normItem = item.toLowerCase().trim();
                        const existsInList = groceryList.some(i => i.toLowerCase() === normItem);
                        const wasDeleted = deletedItems.some(i => i.toLowerCase() === normItem);
                        
                        if (!existsInList && !wasDeleted) {
                            groceryList.push(item);
                            added++;
                        }
                    });
                    
                    incomingDeleted.forEach(item => {
                        const normItem = item.toLowerCase().trim();
                        const idx = groceryList.findIndex(i => i.toLowerCase() === normItem);
                        if (idx !== -1) {
                            deletedItems.push(groceryList[idx]);
                            groceryList.splice(idx, 1);
                        }
                    });
                    
                    saveData();
                    
                    if (added > 0 || incomingDeleted.length > 0) {
                        let msg = '';
                        if (added > 0) msg += `Added ${added} item(s). `;
                        if (incomingDeleted.length > 0) msg += `${incomingDeleted.length} item(s) marked as deleted.`;
                        showToast(msg.trim());
                        updateUI();
                    }
                    
                    window.history.replaceState({}, '', window.location.pathname);
                } catch (e) { console.error(e); }
            }
        }

        function handleShoppingCompletion() {
            const params = new URLSearchParams(window.location.search);
            const completed = params.get('completed');
            
            if (completed) {
                try {
                    const completedItems = JSON.parse(decodeURIComponent(completed));
                    const itemList = completedItems.join(', ');
                    const confirmed = confirm(`ü¶∏‚Äç‚ôÇÔ∏è Shopping Man Saved the Day!\n\nClear these items from your list?\n\n${itemList}\n\nTap OK to clear them, or Cancel to keep them.`);
                    
                    if (confirmed) {
                        completedItems.forEach(item => {
                            const idx = groceryList.findIndex(i => i.toLowerCase() === item.toLowerCase());
                            if (idx !== -1) {
                                deletedItems.push(groceryList[idx]);
                                groceryList.splice(idx, 1);
                            }
                        });
                        saveData();
                        showToast(`ü¶∏‚Äç‚ôÇÔ∏è Cleared ${completedItems.length} completed item(s)!`);
                        updateUI();
                    }
                    
                    window.history.replaceState({}, '', window.location.pathname);
                } catch (e) { console.error(e); }
            }
        }

        function shareList() {
            if (groceryList.length === 0 && deletedItems.length === 0) return showToast('List is empty!');
            
            const itemsParam = encodeURIComponent(JSON.stringify(groceryList));
            const deletedParam = deletedItems.length > 0 ? `&deleted=${encodeURIComponent(JSON.stringify(deletedItems))}` : '';
            const url = `${window.location.origin}${window.location.pathname}?items=${itemsParam}${deletedParam}`;
            
            const activeItems = groceryList.filter(i => !deletedItems.some(d => d.toLowerCase() === i.toLowerCase()));
            const text = `My grocery list: ${activeItems.join(', ')}${deletedItems.length > 0 ? ` (${deletedItems.length} removed)` : ''}`;
            
            if (navigator.share) {
                navigator.share({ title: 'Grocery List', text, url })
                    .then(() => { saveToHistory('shared'); showToast('Shared!'); })
                    .catch(() => fallbackShare(url, text));
            } else {
                fallbackShare(url, text);
            }
        }

        function fallbackShare(url, text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(`${text}\n\n${url}`)
                    .then(() => showToast('Link copied! Paste in a text message.'));
            } else {
                alert(`Share this link:\n\n${url}`);
            }
        }

        async function checkMicPermission() {
            try {
                if (navigator.permissions) {
                    const result = await navigator.permissions.query({ name: 'microphone' });
                    micPermitted = result.state === 'granted';
                    document.getElementById('permission-banner').classList.toggle('show', !micPermitted);
                } else {
                    document.getElementById('permission-banner').classList.add('show');
                }
            } catch (e) {
                document.getElementById('permission-banner').classList.add('show');
            }
        }

        async function requestMicrophonePermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(t => t.stop());
                micPermitted = true;
                document.getElementById('permission-banner').classList.remove('show');
                showToast('Microphone granted!');
            } catch (e) {
                alert('Microphone access required.\n\n1. Tap lock icon in address bar\n2. Allow microphone\n3. Reload page');
            }
        }

        function setupVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return;
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SR();
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onresult = e => {
                let interim = '', final = '';
                for (let i = e.resultIndex; i < e.results.length; i++) {
                    const transcript = e.results[i][0].transcript;
                    if (e.results[i].isFinal) final += transcript + ' ';
                    else interim += transcript;
                }
                if (final) {
                    currentTranscript += final;
                    processVoice(currentTranscript);
                }
                document.getElementById('status-text').textContent = interim || currentTranscript || 'Listening...';
            };

            recognition.onerror = e => {
                if (e.error === 'not-allowed') {
                    stopListening();
                    document.getElementById('permission-banner').classList.add('show');
                } else if (e.error !== 'no-speech') stopListening();
            };

            recognition.onend = () => { if (isListening) try { recognition.start(); } catch(e) { stopListening(); } };
        }

        function toggleVoice() {
            if (!micPermitted) return requestMicrophonePermission();
            isListening ? stopListening() : startListening();
        }

        function startListening() {
            if (!recognition) return;
            isListening = true;
            currentTranscript = '';
            document.getElementById('mic-button').classList.add('listening');
            document.getElementById('status-text').textContent = 'Listening...';
            try { recognition.start(); } catch(e) { stopListening(); }
        }

        function stopListening() {
            isListening = false;
            if (recognition) recognition.stop();
            document.getElementById('mic-button').classList.remove('listening');
            document.getElementById('status-text').textContent = 'Tap the microphone and say your items. Pause between items. Once you are finished adding items, tap the microphone again to turn it off.\n\nSwipe right to see quick select screens, list and SHOPPING MAN MODE!';
        }

        function processVoice(transcript) {
            // Split on common punctuation and natural pauses
            const items = transcript.split(/[.,;!?]|\s{2,}/)
                .map(i => i.trim().replace(/^(and|add|also|plus)\s+/i, ''))
                .filter(i => i.length > 2);
            
            items.forEach(item => {
                if (item.length > 0) addItem(item);
            });
            
            if (items.length > 0) currentTranscript = '';
        }

        function addItem(name, silent = false) {
            if (!name) return false;
            const norm = name.toLowerCase().trim();
            
            const deletedIdx = deletedItems.findIndex(i => i.toLowerCase() === norm);
            if (deletedIdx !== -1) {
                deletedItems.splice(deletedIdx, 1);
            }
            
            if (groceryList.some(i => i.toLowerCase() === norm)) {
                if (!silent) showToast(`"${name}" already on list`);
                return false;
            }

            const words = norm.split(' ');
            const similar = groceryList.some(existing => {
                const eWords = existing.toLowerCase().split(' ');
                return words.some(w => w.length > 3 && eWords.some(e => e.includes(w) || w.includes(e)));
            });

            if (similar) {
                const diff = words.some(w => w.length > 3 && !groceryList.some(i => i.toLowerCase().includes(w)));
                if (!diff) {
                    if (!silent) showToast('Similar item already on list');
                    return false;
                }
            }

            groceryList.push(name);
            itemFrequency[norm] = (itemFrequency[norm] || 0) + 1;
            saveData();
            if (!silent) {
                showToast(`Added: ${name}`);
                playSound('yum');
            }
            updateUI();
            return true;
        }

        function removeItem(idx) {
            playSound('yuck');
            const item = groceryList[idx];
            deletedItems.push(item);
            groceryList.splice(idx, 1);
            saveData();
            showToast(`Removed: ${item}`);
            updateUI();
        }

        function restoreItem(item) {
            deletedItems = deletedItems.filter(i => i.toLowerCase() !== item.toLowerCase());
            groceryList.push(item);
            saveData();
            updateUI();
            showToast(`Restored: ${item}`);
        }

        function updateUI() {
            const activeCount = groceryList.length;
            document.getElementById('item-count').textContent = activeCount;
            updateListDisplay();
            updateQuickAdd();
            updateNavDots();
        }

        function updateListDisplay() {
            const list = document.getElementById('current-list');
            if (groceryList.length === 0 && deletedItems.length === 0) {
                list.innerHTML = '<div class="empty-state">Your list is empty.<br>Add items using voice or quick add!</div>';
            } else {
                let html = '';
                groceryList.forEach((item, i) => {
                    html += `<div class="list-item"><span>${item}</span><button class="delete-btn" onclick="removeItem(${i})">Remove</button></div>`;
                });
                deletedItems.forEach(item => {
                    html += `<div class="list-item deleted">
                        <span>${item} (removed by you)</span>
                        <button class="delete-btn" onclick="restoreItem('${item.replace(/'/g, "\\'")}')">Restore</button>
                    </div>`;
                });
                list.innerHTML = html;
            }
        }

        function updateQuickAdd() {
            const sixWeeksAgo = Date.now() - (6 * 7 * 24 * 60 * 60 * 1000);
            const sorted = Object.entries(itemFrequency)
                .sort((a,b) => b[1] - a[1])
                .map(([item]) => item.charAt(0).toUpperCase() + item.slice(1))
                .slice(0, 15);
            
            const items = [...sorted];
            defaultQuickItems.forEach(item => {
                if (items.length >= 20) return;
                if (!items.some(i => i.toLowerCase() === item.toLowerCase())) items.push(item);
            });

            document.getElementById('quick-items').innerHTML = items.slice(0, 20).map((item, i) =>
                `<div class="quick-item"><input type="checkbox" id="q${i}" value="${item}"><label for="q${i}">${item}</label></div>`
            ).join('');
        }

        function addQuickItems() {
            let added = 0;
            document.querySelectorAll('.quick-item input:checked').forEach(cb => {
                if (addItem(cb.value, true)) added++;
                cb.checked = false;
            });
            showToast(added > 0 ? `Added ${added} item(s)` : 'No items selected or already on list');
        }

        function addManualItem() {
            const input = document.getElementById('manual-input');
            if (input.value.trim()) {
                addItem(input.value.trim());
                input.value = '';
            }
        }

        function emailList() {
            if (groceryList.length === 0) return showToast('List is empty!');
            const text = groceryList.map((i, idx) => `${idx+1}. ${i}`).join('\n');
            const subject = `Grocery List - ${new Date().toLocaleDateString()}`;
            const body = `Here's your grocery list:\n\n${text}\n\nGenerated by Grocery List App`;
            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            saveToHistory('emailed');
        }

        function resetList() {
            if (groceryList.length === 0 && deletedItems.length === 0) return showToast('List already empty!');
            if (confirm('Clear all items (including deleted)?')) {
                saveToHistory('reset');
                groceryList = [];
                deletedItems = [];
                shoppingChecked = [];
                saveData();
                updateUI();
                showToast('List reset!');
            }
        }

        function clearOldHistory() {
            const eightWeeksAgo = Date.now() - (8 * 7 * 24 * 60 * 60 * 1000);
            const originalLength = history.length;
            history = history.filter(h => new Date(h.date).getTime() > eightWeeksAgo);
            
            const removed = originalLength - history.length;
            if (removed > 0) {
                saveData();
                showToast(`Cleared ${removed} old history entries`);
                showHistory();
            } else {
                showToast('No history older than 8 weeks');
            }
        }

        function saveToHistory(action) {
            if (groceryList.length === 0 && deletedItems.length === 0) return;
            history.unshift({ 
                date: new Date().toISOString(), 
                action, 
                items: [...groceryList], 
                deleted: [...deletedItems] 
            });
            if (history.length > 20) history = history.slice(0, 20);
            saveData();
        }

        // Shopping Man Mode
        function updateShoppingList() {
            const container = document.getElementById('shopping-list');
            const activeItems = groceryList.filter(item => 
                !deletedItems.some(d => d.toLowerCase() === item.toLowerCase())
            );
            
            if (activeItems.length === 0) {
                container.innerHTML = '<div style="color: white; text-align: center; padding: 40px; font-size: 18px;">No items to shop for! Add some items first.</div>';
                return;
            }
            
            container.innerHTML = activeItems.map((item, idx) => {
                const isChecked = shoppingChecked.includes(item);
                return `<div class="shopping-item ${isChecked ? 'checked' : ''}">
                    <input type="checkbox" 
                           id="shop-${idx}" 
                           ${isChecked ? 'checked' : ''}
                           onchange="toggleShoppingItem('${item.replace(/'/g, "\\'")}')">
                    <span>${item}</span>
                </div>`;
            }).join('');
            
            updateShoppingProgress();
        }

        function toggleShoppingItem(item) {
            const idx = shoppingChecked.indexOf(item);
            if (idx === -1) {
                shoppingChecked.push(item);
                playSound('swoosh');
            } else {
                shoppingChecked.splice(idx, 1);
            }
            saveData();
            updateShoppingList();
        }

        function updateShoppingProgress() {
            const activeItems = groceryList.filter(item => 
                !deletedItems.some(d => d.toLowerCase() === item.toLowerCase())
            );
            const total = activeItems.length;
            const checked = shoppingChecked.length;
            const percentage = total > 0 ? (checked / total) * 100 : 0;
            
            const progressFill = document.getElementById('shopping-progress');
            progressFill.style.width = percentage + '%';
            progressFill.textContent = `${checked}/${total} items`;
            
            if (checked === total && total > 0) {
                progressFill.style.background = 'linear-gradient(90deg, #FFD700, #FFA500)';
            } else {
                progressFill.style.background = 'linear-gradient(90deg, #4CAF50, #8BC34A)';
            }
        }

        function fulfillFoodDuties() {
            if (shoppingChecked.length === 0) {
                showToast('Check off items as you add them to your cart!');
                return;
            }
            
            const completedParam = encodeURIComponent(JSON.stringify(shoppingChecked));
            const url = `${window.location.origin}${window.location.pathname}?completed=${completedParam}`;
            const text = `ü¶∏‚Äç‚ôÇÔ∏è Shopping Man Saved the Day!\n\nI got: ${shoppingChecked.join(', ')}`;
            
            if (navigator.share) {
                navigator.share({ title: 'Shopping Complete!', text, url })
                    .then(() => {
                        shoppingChecked.forEach(item => {
                            const idx = groceryList.findIndex(i => i === item);
                            if (idx !== -1) {
                                deletedItems.push(item);
                                groceryList.splice(idx, 1);
                            }
                        });
                        shoppingChecked = [];
                        saveData();
                        saveToHistory('shopping_completed');
                        showToast('ü¶∏‚Äç‚ôÇÔ∏è Food duties fulfilled! Items marked as complete.');
                        updateUI();
                        showScreen('voice-screen');
                    })
                    .catch(() => fallbackShare(url, text));
            } else {
                fallbackShare(url, text);
            }
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (id === 'edit-screen') updateListDisplay();
            else if (id === 'quick-screen') updateQuickAdd();
            else if (id === 'history-screen') showHistory();
            else if (id === 'shopping-screen') updateShoppingList();
            updateNavDots();
        }

        function showHistory() {
            const list = document.getElementById('history-list');
            if (history.length === 0) {
                list.innerHTML = '<div class="empty-state">No past lists yet</div>';
            } else {
                list.innerHTML = history.map(h => {
                    const date = new Date(h.date).toLocaleString();
                    const emoji = h.action === 'emailed' ? 'üìß' : (h.action === 'shared' ? 'üì±' : (h.action === 'shopping_completed' ? 'ü¶∏‚Äç‚ôÇÔ∏è' : 'üîÑ'));
                    const action = h.action === 'emailed' ? 'Emailed' : (h.action === 'shared' ? 'Shared' : (h.action === 'shopping_completed' ? 'Shopping Man!' : 'Reset'));
                    const allItems = [...(h.items || []), ...(h.deleted || []).map(i => `~~${i}~~`)];
                    return `<div class="history-item">
                        <h3>${emoji} ${action}</h3>
                        <p><strong>Date:</strong> ${date}</p>
                        <p><strong>Items (${h.items?.length || 0} active, ${h.deleted?.length || 0} deleted):</strong></p>
                        <ul>${allItems.slice(0,10).map(i => `<li>${i}</li>`).join('')}
                        ${allItems.length > 10 ? `<li><em>...and ${allItems.length-10} more</em></li>` : ''}</ul>
                    </div>`;
                }).join('');
            }
        }

        function updateNavDots() {
            document.querySelectorAll('.dot').forEach((d, i) => {
                const screens = ['voice-screen', 'quick-screen', 'edit-screen', 'shopping-screen'];
                d.classList.toggle('active', document.getElementById(screens[i]).classList.contains('active'));
            });
        }

        function showToast(msg) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        let touchX = 0;
        document.addEventListener('touchstart', e => touchX = e.changedTouches[0].screenX);
        document.addEventListener('touchend', e => {
            const diff = touchX - e.changedTouches[0].screenX;
            if (Math.abs(diff) < 50) return;
            const active = document.querySelector('.screen.active').id;
            if (diff > 0) {
                if (active === 'voice-screen') showScreen('quick-screen');
                else if (active === 'quick-screen') showScreen('edit-screen');
                else if (active === 'edit-screen') showScreen('shopping-screen');
            } else {
                if (active === 'shopping-screen') showScreen('edit-screen');
                else if (active === 'edit-screen') showScreen('quick-screen');
                else if (active === 'quick-screen') showScreen('voice-screen');
            }
        });

        document.addEventListener('keypress', e => {
            if (e.target.id === 'manual-input' && e.key === 'Enter') addManualItem();
        });

        window.addEventListener('load', init);
    </script>
</body>
</html>
