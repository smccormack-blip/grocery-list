<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Grocery List - Shopping Man Edition</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(to bottom, #f5f5f0, #e8e8e0);
            min-height: 100vh;
        }
        
        /* List Selector */
        .list-selector {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .list-selector select {
            font-size: 18px;
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid white;
            background: white;
            color: #667eea;
            font-weight: bold;
            cursor: pointer;
            min-width: 200px;
        }
        .list-selector select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.5);
        }
        
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; font-size: 28px; }
        .status-text {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 60px 0 30px;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.6;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .mic-button {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 40px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(102,126,234,0.4);
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mic-button.listening {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .action-buttons { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .btn {
            flex: 1;
            min-width: 120px;
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
        }
        .btn-secondary { background: white; color: #667eea; border: 2px solid #667eea; }
        .btn-share { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .permission-banner {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        .permission-banner.show { display: block; }
        .permission-banner h3 { color: #856404; margin-bottom: 10px; }
        .permission-banner p { color: #856404; margin-bottom: 10px; }
        .permission-banner button {
            background: #ffc107;
            color: #856404;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }
        .quick-items { display: grid; gap: 12px; margin-top: 20px; }
        .quick-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        .quick-item input { width: 24px; height: 24px; margin-right: 15px; cursor: pointer; }
        .quick-item label { font-size: 18px; color: #2c3e50; cursor: pointer; flex-grow: 1; }
        .list-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .list-item span { font-size: 18px; color: #2c3e50; }
        .list-item.deleted { opacity: 0.6; }
        .list-item.deleted span { text-decoration: line-through; color: #999; }
        .delete-btn {
            background: #8b0000;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        .remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }
        .button-group {
            display: flex;
            gap: 8px;
        }
        .manual-add { display: flex; gap: 10px; margin-bottom: 20px; }
        .manual-add input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        .manual-add button {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .empty-state { text-align: center; color: #999; padding: 40px 20px; }
        .history-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .history-item h3 { color: #2c3e50; font-size: 16px; margin-bottom: 8px; }
        .history-item p { color: #777; font-size: 14px; margin-bottom: 6px; }
        .history-item ul { margin-top: 10px; padding-left: 20px; color: #555; }
        
        /* Shopping Man Screen */
        .shopping-screen {
            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), 
                        url('Shopping_Man.jpg') center/cover;
            border-radius: 15px;
            padding: 20px;
            min-height: 80vh;
        }
        .shopping-screen h1 {
            color: #ffd700;
            text-shadow: 3px 3px 6px #000, 0 0 15px #ff0000, 0 0 25px #ff0000;
            font-size: 28px;
            margin-bottom: 15px;
            animation: heroGlow 2s infinite;
        }
        @keyframes heroGlow {
            0%, 100% { text-shadow: 3px 3px 6px #000, 0 0 15px #ff0000; }
            50% { text-shadow: 3px 3px 6px #000, 0 0 25px #ff0000, 0 0 35px #ff6600; }
        }
        
        /* Category Sections */
        .category-section {
            margin-bottom: 25px;
        }
        .category-header {
            color: #ffd700;
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 12px;
            padding: 8px 12px;
            background: rgba(255,215,0,0.2);
            border-radius: 8px;
            text-shadow: 2px 2px 4px #000;
            border-left: 4px solid #ffd700;
        }
        
        .progress-bar {
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            height: 35px;
            margin: 15px 0 25px;
            overflow: hidden;
            border: 2px solid rgba(255,215,0,0.5);
        }
        .progress-fill {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 0 10px rgba(76,175,80,0.8);
        }
        .shopping-item {
            background: rgba(255,255,255,0.95);
            padding: 15px;
            margin: 12px 0;
            border-radius: 12px;
            display: flex;
            align-items: center;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .shopping-item.checked {
            background: rgba(76,175,80,0.4);
            transform: scale(0.98);
        }
        .shopping-item.checked span {
            text-decoration: line-through;
            color: #4CAF50;
            font-weight: bold;
        }
        .shopping-item input[type="checkbox"] {
            width: 32px;
            height: 32px;
            margin-right: 15px;
            cursor: pointer;
            accent-color: #4CAF50;
        }
        .shopping-item span {
            font-size: 20px;
            color: #2c3e50;
            flex-grow: 1;
            font-weight: 500;
        }
        .fulfill-button {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 15px;
            font-size: 22px;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(255,107,107,0.5);
            animation: pulse-glow 2s infinite;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 6px 20px rgba(255,107,107,0.5); transform: scale(1); }
            50% { box-shadow: 0 10px 35px rgba(255,107,107,0.9); transform: scale(1.02); }
        }
        .fulfill-button:active { transform: scale(0.95); }
        
        .nav-dots {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            border: 2px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }
        .dot.active { background: #667eea; transform: scale(1.3); }
        .dot:last-child {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            background: rgba(255,215,0,0.3);
            border-color: #ffd700;
        }
        .dot:last-child.active {
            background: #ffd700;
            box-shadow: 0 0 15px rgba(255,215,0,0.8);
        }
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideUp 0.3s;
            max-width: 90%;
            text-align: center;
        }
        @keyframes slideUp { from { bottom: 50px; opacity: 0; } to { bottom: 100px; opacity: 1; } }
        
        /* Victory Video Modal */
        .victory-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .victory-modal.show {
            display: flex;
        }
        .victory-container {
            position: relative;
            max-width: 90%;
            max-height: 90%;
        }
        .victory-modal video {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(255,215,0,0.5);
            display: block;
        }
        .play-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.7);
            border-radius: 15px;
            z-index: 10;
        }
        .play-overlay.hidden {
            display: none;
        }
        .play-button {
            background: linear-gradient(135deg, #ffd700, #ffa500);
            color: #000;
            border: 3px solid #fff;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(255,215,0,0.5);
            animation: pulse-glow 2s infinite;
        }
        .victory-modal .skip-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }
        
        /* Flying Shopping Man Animation */
        .flying-hero {
            position: fixed;
            bottom: 120px;
            left: -100px;
            width: 80px;
            height: 80px;
            font-size: 60px;
            animation: fly 15s linear infinite;
            z-index: 50;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }
        @keyframes fly {
            0% { left: -100px; }
            50% { left: 100%; }
            50.01% { left: 100%; transform: scaleX(-1); }
            100% { left: -100px; transform: scaleX(-1); }
        }
        .follower {
            position: fixed;
            bottom: 120px;
            font-size: 40px;
            animation: follow 15s linear infinite;
            z-index: 49;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }
        .follower-1 { animation-delay: 2s; bottom: 145px; }
        .follower-2 { animation-delay: 4s; bottom: 95px; }
        .follower-3 { animation-delay: 6s; bottom: 130px; }
        @keyframes follow {
            0% { left: -120px; opacity: 0; }
            10% { opacity: 1; }
            40% { opacity: 1; }
            50% { left: calc(100% - 50px); opacity: 0; }
            50.01% { left: calc(100% - 50px); transform: scaleX(-1); opacity: 0; }
            60% { opacity: 1; }
            90% { opacity: 1; }
            100% { left: -120px; transform: scaleX(-1); opacity: 0; }
        }

        /* Tutorial Modal Styles */
        .tutorial-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }
        .tutorial-modal.show {
            display: flex;
        }
        .tutorial-container {
            max-width: 600px;
            width: 100%;
            text-align: center;
        }
        .tutorial-title {
            color: #ffd700;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .tutorial-subtitle {
            color: #fff;
            font-size: 16px;
            margin-bottom: 20px;
            opacity: 0.8;
        }
        .tutorial-step-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
        }
        .step-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transition: all 0.3s;
        }
        .step-dot.active {
            background: #ffd700;
            transform: scale(1.3);
        }
        .step-dot.completed {
            background: #4CAF50;
        }
        .tutorial-phones {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .phone-mockup {
            width: 140px;
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            border-radius: 20px;
            padding: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.1);
            position: relative;
        }
        .phone-notch {
            width: 50px;
            height: 6px;
            background: #000;
            border-radius: 3px;
            margin: 0 auto 8px;
        }
        .phone-screen {
            background: linear-gradient(to bottom, #f5f5f0, #e8e8e0);
            border-radius: 12px;
            min-height: 200px;
            padding: 10px;
            position: relative;
            overflow: hidden;
        }
        .phone-label {
            color: #ffd700;
            font-size: 14px;
            font-weight: bold;
            margin-top: 10px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .phone-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 6px;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .phone-list {
            text-align: left;
        }
        .phone-item {
            background: white;
            padding: 6px 8px;
            border-radius: 6px;
            margin: 4px 0;
            font-size: 11px;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }
        .phone-item.show {
            opacity: 1;
            transform: translateY(0);
        }
        .phone-item.removed {
            opacity: 0.5;
            text-decoration: line-through;
            background: #ffebee;
        }
        .phone-item.checked {
            background: #e8f5e9;
        }
        .phone-item .item-check {
            color: #4CAF50;
            font-weight: bold;
        }
        .phone-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 9px;
            margin-top: 8px;
            display: inline-block;
        }
        .phone-btn.share {
            background: #3498db;
        }
        .phone-btn.success {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
        }
        .share-arrow {
            font-size: 40px;
            color: #ffd700;
            animation: bounceArrow 1s infinite;
            display: none;
        }
        .share-arrow.show {
            display: block;
        }
        @keyframes bounceArrow {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(10px); }
        }
        .tutorial-description {
            color: white;
            font-size: 16px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            line-height: 1.5;
        }
        .tutorial-nav {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        .tutorial-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tutorial-btn.next {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .tutorial-btn.prev {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
        }
        .tutorial-btn.close {
            background: #e74c3c;
            color: white;
        }
        .tutorial-btn:hover {
            transform: scale(1.05);
        }
        .tutorial-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .celebration-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.7);
            border-radius: 12px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .celebration-overlay.show {
            opacity: 1;
        }
        .celebration-text {
            color: #ffd700;
            font-size: 10px;
            font-weight: bold;
            text-align: center;
            animation: celebratePulse 0.5s infinite alternate;
        }
        @keyframes celebratePulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }
        .flying-item {
            position: absolute;
            font-size: 20px;
            opacity: 0;
            pointer-events: none;
        }
        .flying-item.animate {
            animation: flyAcross 1s ease-out forwards;
        }
        @keyframes flyAcross {
            0% { opacity: 1; transform: translateX(0) scale(1); }
            100% { opacity: 0; transform: translateX(100px) scale(0.5); }
        }
        .btn-tutorial {
            background: linear-gradient(135deg, #ffd700, #ffa500);
            color: #2c3e50;
            border: 2px solid #ffd700;
        }
        .btn-tutorial:hover {
            box-shadow: 0 0 15px rgba(255,215,0,0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="list-selector">
            <select id="list-type" onchange="switchList()">
                <option value="home">üè† Home List</option>
                <option value="office">üíº Office List</option>
            </select>
        </div>
        
        <div class="permission-banner" id="permission-banner">
            <h3>üé§ Microphone Access Needed</h3>
            <p>To use voice input, this app needs permission to access your microphone.</p>
            <button onclick="requestMicrophonePermission()">Grant Microphone Access</button>
        </div>

        <div id="voice-screen" class="screen active">
            <h1>üõí Grocery List</h1>
            <div class="status-text" id="status-text">
                Tap the microphone and say your items. Pause between items. Once you are finished adding items, tap the microphone again to turn it off.<br><br>
                Swipe right to see quick select screens, list and SHOPPING MAN MODE!
            </div>
            <button class="mic-button" id="mic-button" onclick="toggleVoice()">üé§</button>
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="showScreen('edit-screen')">
                    View List (<span id="item-count">0</span>)
                </button>
                <button class="btn btn-share" onclick="shareList()">üì± Share List</button>
                <button class="btn btn-tutorial" onclick="openTutorial()">‚ùì Tutorial</button>
            </div>

            <!-- Flying Shopping Man and Friends -->
            <div class="flying-hero">ü¶∏‚Äç‚ôÇÔ∏è</div>
            <div class="follower follower-1">ü¶Ñ</div>
            <div class="follower follower-2">üê±</div>
            <div class="follower follower-3">ü¶Ñ</div>
        </div>

        <div id="quick-screen" class="screen">
            <h1>Quick Add Items</h1>
            <div class="quick-items" id="quick-items"></div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="addQuickItems()">Add Selected</button>
                <button class="btn btn-secondary" onclick="showScreen('voice-screen')">Back</button>
            </div>
        </div>

        <div id="edit-screen" class="screen">
            <h1>Current List</h1>
            <div class="manual-add">
                <input type="text" id="manual-input" placeholder="Type item name...">
                <button onclick="addManualItem()">Add</button>
            </div>
            <div id="current-list"></div>
            <div class="action-buttons">
                <button class="btn btn-share" onclick="shareList()">üì± Share</button>
                <button class="btn btn-success" onclick="emailList()">üìß Email</button>
                <button class="btn btn-danger" onclick="resetList()">Reset</button>
                <button class="btn btn-secondary" onclick="showScreen('history-screen')">History</button>
                <button class="btn btn-secondary" onclick="showScreen('voice-screen')">Back</button>
            </div>
        </div>

        <div id="history-screen" class="screen">
            <h1>Past Lists</h1>
            <div id="history-list"></div>
            <div class="action-buttons">
                <button class="btn btn-danger" onclick="clearOldHistory()">Clear Old History (8+ weeks)</button>
                <button class="btn btn-secondary" onclick="showScreen('edit-screen')">Back</button>
            </div>
        </div>

        <div id="shopping-screen" class="screen">
            <div class="shopping-screen">
                <h1>ü¶∏‚Äç‚ôÇÔ∏è SHOPPING MAN MODE ü¶∏‚Äç‚ôÇÔ∏è</h1>
                <div class="progress-bar">
                    <div class="progress-fill" id="shopping-progress" style="width: 0%">0/0</div>
                </div>
                <div id="shopping-list"></div>
                <button class="fulfill-button" onclick="fulfillFoodDuties()">
                    ü¶∏‚Äç‚ôÇÔ∏è FULFILLED FOOD DUTIES! ü¶∏‚Äç‚ôÇÔ∏è
                </button>
                <div class="action-buttons" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="showScreen('voice-screen')">Back</button>
                </div>
            </div>
        </div>
    </div>

    <div class="nav-dots">
        <div class="dot active" onclick="showScreen('voice-screen')"></div>
        <div class="dot" onclick="showScreen('quick-screen')"></div>
        <div class="dot" onclick="showScreen('edit-screen')"></div>
        <div class="dot" onclick="showScreen('shopping-screen')">ü¶∏</div>
    </div>

    <!-- Victory Video Modal -->
    <div class="victory-modal" id="victory-modal">
        <div class="victory-container">
            <div class="play-overlay" id="play-overlay">
                <button class="play-button" onclick="playVictoryVideo()">
                    üé• Tap to See Shopping Man's Victory!
                </button>
            </div>
            <video id="victory-video" playsinline>
                <source src="victory.mp4" type="video/mp4">
            </video>
        </div>
        <button class="skip-button" onclick="closeVictoryVideo()" style="display: none;" id="skip-button">Skip</button>
    </div>

    <!-- Tutorial Modal -->
    <div class="tutorial-modal" id="tutorial-modal">
        <div class="tutorial-container">
            <div class="tutorial-title">üì± How It Works</div>
            <div class="tutorial-subtitle">Share your grocery list between two people</div>

            <div class="tutorial-step-indicator">
                <div class="step-dot active" data-step="1"></div>
                <div class="step-dot" data-step="2"></div>
                <div class="step-dot" data-step="3"></div>
                <div class="step-dot" data-step="4"></div>
            </div>

            <div class="tutorial-phones">
                <div class="phone-mockup" id="phone-a">
                    <div class="phone-notch"></div>
                    <div class="phone-screen" id="phone-a-screen">
                        <div class="phone-header">üõí Grocery List</div>
                        <div class="phone-list" id="phone-a-list"></div>
                    </div>
                    <div class="phone-label">üë§ Person A</div>
                </div>

                <div class="share-arrow" id="share-arrow">‚û°Ô∏è</div>

                <div class="phone-mockup" id="phone-b">
                    <div class="phone-notch"></div>
                    <div class="phone-screen" id="phone-b-screen">
                        <div class="phone-header">üõí Grocery List</div>
                        <div class="phone-list" id="phone-b-list"></div>
                        <div class="celebration-overlay" id="celebration-overlay">
                            <div class="celebration-text">ü¶∏‚Äç‚ôÇÔ∏è Shopping Man<br>Saves the Day! ü¶∏‚Äç‚ôÇÔ∏è</div>
                        </div>
                    </div>
                    <div class="phone-label">üë§ Person B</div>
                </div>
            </div>

            <div class="tutorial-description" id="tutorial-description">
                Welcome! This app lets two people share a grocery list. Let's see how it works!
            </div>

            <div class="tutorial-nav">
                <button class="tutorial-btn prev" id="tutorial-prev" onclick="tutorialPrev()" disabled>Back</button>
                <button class="tutorial-btn next" id="tutorial-next" onclick="tutorialNext()">Next</button>
                <button class="tutorial-btn close" onclick="closeTutorial()">Skip</button>
            </div>
        </div>
    </div>

    <script>
        let groceryList = [];
        let deletedItems = [];
        let shoppingChecked = [];
        let itemFrequency = {};
        let history = [];
        let isListening = false;
        let recognition = null;
        let currentTranscript = '';
        let micPermitted = false;
        let currentListType = 'home'; // Current list: 'home' or 'office'
        let itemOwnership = {}; // Track who added each item
        let permanentDeletions = {}; // Track permanently deleted items
        let deviceId = localStorage.getItem('deviceId') || generateDeviceId();
        let lastSharedTimestamp = {}; // Track when each item was last shared

        const defaultQuickItems = ['Eggs','Milk','Bread','Butter','Cheese','Chicken','Bananas','Apples','Lettuce','Tomatoes','Onions','Potatoes','Rice','Pasta','Coffee'];

        // Category definitions for store sections
        const itemCategories = {
            // Produce
            'apples': 'produce', 'bananas': 'produce', 'oranges': 'produce', 'grapes': 'produce',
            'lettuce': 'produce', 'tomatoes': 'produce', 'onions': 'produce', 'potatoes': 'produce',
            'carrots': 'produce', 'celery': 'produce', 'peppers': 'produce', 'cucumbers': 'produce',
            'broccoli': 'produce', 'cauliflower': 'produce', 'spinach': 'produce', 'avocados': 'produce',
            
            // Dairy
            'milk': 'dairy', 'eggs': 'dairy', 'butter': 'dairy', 'cheese': 'dairy',
            'yogurt': 'dairy', 'cream': 'dairy', 'half and half': 'dairy', 'sour cream': 'dairy',
            'cottage cheese': 'dairy', 'cream cheese': 'dairy',
            
            // Meat
            'chicken': 'meat', 'beef': 'meat', 'pork': 'meat', 'turkey': 'meat',
            'bacon': 'meat', 'sausage': 'meat', 'ham': 'meat', 'meat': 'meat',
            'ground beef': 'meat', 'steak': 'meat', 'fish': 'meat', 'salmon': 'meat',
            
            // Bakery
            'bread': 'bakery', 'bagels': 'bakery', 'muffins': 'bakery', 'croissants': 'bakery',
            'donuts': 'bakery', 'rolls': 'bakery', 'tortillas': 'bakery',
            
            // Grocery (everything else)
            'rice': 'grocery', 'pasta': 'grocery', 'cereal': 'grocery', 'coffee': 'grocery',
            'tea': 'grocery', 'sugar': 'grocery', 'flour': 'grocery', 'oil': 'grocery',
            'olive oil': 'grocery', 'salt': 'grocery', 'pepper': 'grocery',
            'ketchup': 'grocery', 'mustard': 'grocery', 'mayo': 'grocery', 'hot sauce': 'grocery',
            'soy sauce': 'grocery', 'bouillon cubes': 'grocery', 'canned goods': 'grocery',
            'soup': 'grocery', 'beans': 'grocery', 'cat food': 'grocery', 'dog food': 'grocery',
            'peanut butter': 'grocery', 'jelly': 'grocery', 'jam': 'grocery',
            'orange juice': 'grocery', 'apple juice': 'grocery', 'soda': 'grocery',
            'water': 'grocery', 'chips': 'grocery', 'cookies': 'grocery', 'crackers': 'grocery',
            'ice cream': 'grocery', 'frozen': 'grocery'
        };

        const categoryNames = {
            'produce': 'ü•¨ Produce',
            'dairy': 'ü•õ Dairy',
            'meat': 'ü•© Meat',
            'bakery': 'ü•ñ Bakery',
            'grocery': 'üõí Grocery'
        };

        const categoryOrder = ['produce', 'dairy', 'meat', 'bakery', 'grocery'];

        function generateDeviceId() {
            const id = 'device_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('deviceId', id);
            return id;
        }

        function getCategory(itemName) {
            const normalized = itemName.toLowerCase().trim();
            return itemCategories[normalized] || 'grocery';
        }

        function getCurrentListType() {
            // Get from URL hash, or from localStorage, or default to 'home'
            const hash = window.location.hash.slice(1);
            if (hash === 'home' || hash === 'office') {
                return hash;
            }
            return localStorage.getItem('currentListType') || 'home';
        }

        function setCurrentListType(type) {
            currentListType = type;
            localStorage.setItem('currentListType', type);
            window.location.hash = type;
            document.getElementById('list-type').value = type;
        }

        function switchList() {
            const newType = document.getElementById('list-type').value;
            setCurrentListType(newType);
            loadData();
            updateUI();
            showToast(`Switched to ${newType === 'home' ? 'üè† Home' : 'üíº Office'} list`);
        }

        function getStorageKey(key) {
            return `${key}_${currentListType}`;
        }

        // Sound effects
        let yummyAudio = null;
        let yuckAudio = null;
        
        function initSounds() {
            try {
                yummyAudio = new Audio('yummy.m4a');
                yuckAudio = new Audio('yuck.m4a');
                yummyAudio.load();
                yuckAudio.load();
            } catch(e) {
                console.log('Audio init error:', e);
            }
        }
        
        const sounds = {
            yum: () => {
                try {
                    if (yummyAudio) {
                        yummyAudio.currentTime = 0;
                        yummyAudio.play().catch(e => console.log('Yum play failed:', e));
                    }
                } catch(e) {
                    console.log('Yum error:', e);
                }
            },
            yuck: () => {
                try {
                    if (yuckAudio) {
                        yuckAudio.currentTime = 0;
                        yuckAudio.play().catch(e => console.log('Yuck play failed:', e));
                    }
                } catch(e) {
                    console.log('Yuck error:', e);
                }
            },
            swoosh: () => {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(600, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(200, ctx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.3);
            }
        };

        function playSound(type) {
            try { sounds[type](); } catch(e) { console.log('Sound error:', e); }
        }

        function init() {
            currentListType = getCurrentListType();
            setCurrentListType(currentListType);
            loadData();
            initSounds();
            checkMicPermission();
            setupVoiceRecognition();
            updateUI();
            handleIncomingShare();
            handleShoppingCompletion();
        }

        function loadData() {
            groceryList = JSON.parse(localStorage.getItem(getStorageKey('groceryList')) || '[]');
            deletedItems = JSON.parse(localStorage.getItem(getStorageKey('deletedItems')) || '[]');
            itemFrequency = JSON.parse(localStorage.getItem(getStorageKey('itemFrequency')) || '{}');
            history = JSON.parse(localStorage.getItem(getStorageKey('groceryHistory')) || '[]');
            shoppingChecked = JSON.parse(localStorage.getItem(getStorageKey('shoppingChecked')) || '[]');
            itemOwnership = JSON.parse(localStorage.getItem(getStorageKey('itemOwnership')) || '{}');
            permanentDeletions = JSON.parse(localStorage.getItem(getStorageKey('permanentDeletions')) || '{}');
            lastSharedTimestamp = JSON.parse(localStorage.getItem(getStorageKey('lastSharedTimestamp')) || '{}');
        }

        function saveData() {
            localStorage.setItem(getStorageKey('groceryList'), JSON.stringify(groceryList));
            localStorage.setItem(getStorageKey('deletedItems'), JSON.stringify(deletedItems));
            localStorage.setItem(getStorageKey('itemFrequency'), JSON.stringify(itemFrequency));
            localStorage.setItem(getStorageKey('groceryHistory'), JSON.stringify(history));
            localStorage.setItem(getStorageKey('shoppingChecked'), JSON.stringify(shoppingChecked));
            localStorage.setItem(getStorageKey('itemOwnership'), JSON.stringify(itemOwnership));
            localStorage.setItem(getStorageKey('permanentDeletions'), JSON.stringify(permanentDeletions));
            localStorage.setItem(getStorageKey('lastSharedTimestamp'), JSON.stringify(lastSharedTimestamp));
        }

        function handleIncomingShare() {
            const params = new URLSearchParams(window.location.search);
            const shared = params.get('items');
            const sharedDeleted = params.get('deleted');
            const sharedOwnership = params.get('ownership');
            const sharedListType = params.get('list');
            
            // Switch to the correct list if specified
            if (sharedListType && (sharedListType === 'home' || sharedListType === 'office')) {
                if (sharedListType !== currentListType) {
                    currentListType = sharedListType;
                    setCurrentListType(sharedListType);
                    loadData(); // Load the correct list's data
                }
            }
            
            if (shared) {
                try {
                    const incomingItems = JSON.parse(decodeURIComponent(shared));
                    const incomingDeleted = sharedDeleted ? JSON.parse(decodeURIComponent(sharedDeleted)) : [];
                    const incomingOwnership = sharedOwnership ? JSON.parse(decodeURIComponent(sharedOwnership)) : {};
                    
                    let added = 0;
                    incomingItems.forEach(item => {
                        const normItem = item.toLowerCase().trim();
                        const existsInList = groceryList.some(i => i.toLowerCase() === normItem);
                        const wasDeleted = deletedItems.some(i => i.toLowerCase() === normItem);
                        
                        if (!existsInList && !wasDeleted) {
                            groceryList.push(item);
                            // Merge ownership data
                            if (incomingOwnership[normItem]) {
                                itemOwnership[normItem] = incomingOwnership[normItem];
                            }
                            added++;
                        }
                    });
                    
                    incomingDeleted.forEach(item => {
                        const normItem = item.toLowerCase().trim();
                        const idx = groceryList.findIndex(i => i.toLowerCase() === normItem);
                        if (idx !== -1) {
                            deletedItems.push(groceryList[idx]);
                            groceryList.splice(idx, 1);
                        }
                    });
                    
                    saveData();
                    
                    if (added > 0 || incomingDeleted.length > 0) {
                        const listName = currentListType === 'home' ? 'üè† Home' : 'üíº Office';
                        let msg = `${listName} list updated: `;
                        if (added > 0) msg += `${added} item(s) added. `;
                        if (incomingDeleted.length > 0) msg += `${incomingDeleted.length} item(s) marked as deleted.`;
                        showToast(msg.trim());
                        updateUI();
                    }
                    
                    window.history.replaceState({}, '', window.location.pathname + window.location.hash);
                } catch (e) { console.error(e); }
            }
        }

        function handleShoppingCompletion() {
            const params = new URLSearchParams(window.location.search);
            const completed = params.get('completed');
            const sharedListType = params.get('list');
            
            // Switch to the correct list if specified
            if (sharedListType && (sharedListType === 'home' || sharedListType === 'office')) {
                if (sharedListType !== currentListType) {
                    currentListType = sharedListType;
                    setCurrentListType(sharedListType);
                    loadData(); // Load the correct list's data
                }
            }
            
            if (completed) {
                try {
                    const completedItems = JSON.parse(decodeURIComponent(completed));
                    const itemList = completedItems.join(', ');
                    const listName = currentListType === 'home' ? 'üè† Home' : 'üíº Office';
                    
                    // Show victory video first!
                    showVictoryVideo(() => {
                        // After video, show confirmation dialog
                        const confirmed = confirm(`ü¶∏‚Äç‚ôÇÔ∏è Shopping Man Saved the Day!\n\n${listName} list - Clear these items?\n\n${itemList}\n\nTap OK to clear them, or Cancel to keep them.`);
                        
                        if (confirmed) {
                            completedItems.forEach(item => {
                                const normItem = item.toLowerCase();
                                // Remove from active list
                                const idx = groceryList.findIndex(i => i.toLowerCase() === normItem);
                                if (idx !== -1) {
                                    groceryList.splice(idx, 1);
                                }
                            });
                            // BUGFIX: Clear ALL deleted items when accepting completion (including mistakes)
                            deletedItems = [];
                            saveData();
                            showToast(`ü¶∏‚Äç‚ôÇÔ∏è Cleared ${completedItems.length} completed item(s)!`);
                            updateUI();
                        }
                    });
                    
                    window.history.replaceState({}, '', window.location.pathname + window.location.hash);
                } catch (e) { console.error(e); }
            }
        }

        function shareList() {
            if (groceryList.length === 0 && deletedItems.length === 0) return showToast('List is empty!');
            
            // Mark all items as shared with current timestamp
            const now = Date.now();
            groceryList.forEach(item => {
                const norm = item.toLowerCase().trim();
                lastSharedTimestamp[norm] = now;
            });
            saveData();
            
            const itemsParam = encodeURIComponent(JSON.stringify(groceryList));
            const deletedParam = deletedItems.length > 0 ? `&deleted=${encodeURIComponent(JSON.stringify(deletedItems))}` : '';
            const ownershipParam = `&ownership=${encodeURIComponent(JSON.stringify(itemOwnership))}`;
            const listParam = `&list=${currentListType}`;
            const url = `${window.location.origin}${window.location.pathname}?items=${itemsParam}${deletedParam}${ownershipParam}${listParam}#${currentListType}`;
            
            const listName = currentListType === 'home' ? 'üè† Home' : 'üíº Office';
            const activeItems = groceryList.filter(i => !deletedItems.some(d => d.toLowerCase() === i.toLowerCase()));
            const text = `${listName} grocery list: ${activeItems.join(', ')}${deletedItems.length > 0 ? ` (${deletedItems.length} removed)` : ''}`;
            
            if (navigator.share) {
                navigator.share({ title: `${listName} Grocery List`, text, url })
                    .then(() => { saveToHistory('shared'); showToast('Shared!'); updateUI(); })
                    .catch(() => fallbackShare(url, text));
            } else {
                fallbackShare(url, text);
            }
        }

        function fallbackShare(url, text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(`${text}\n\n${url}`)
                    .then(() => showToast('Link copied! Paste in a text message.'));
            } else {
                alert(`Share this link:\n\n${url}`);
            }
        }

        async function checkMicPermission() {
            try {
                if (navigator.permissions) {
                    const result = await navigator.permissions.query({ name: 'microphone' });
                    micPermitted = result.state === 'granted';
                    document.getElementById('permission-banner').classList.toggle('show', !micPermitted);
                } else {
                    document.getElementById('permission-banner').classList.add('show');
                }
            } catch (e) {
                document.getElementById('permission-banner').classList.add('show');
            }
        }

        async function requestMicrophonePermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(t => t.stop());
                micPermitted = true;
                document.getElementById('permission-banner').classList.remove('show');
                showToast('Microphone granted!');
            } catch (e) {
                alert('Microphone access required.\n\n1. Tap lock icon in address bar\n2. Allow microphone\n3. Reload page');
            }
        }

        function setupVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return;
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SR();
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onresult = e => {
                let interim = '', final = '';
                for (let i = e.resultIndex; i < e.results.length; i++) {
                    const transcript = e.results[i][0].transcript;
                    if (e.results[i].isFinal) final += transcript + ' ';
                    else interim += transcript;
                }
                if (final) {
                    currentTranscript += final;
                    processVoice(currentTranscript);
                }
                document.getElementById('status-text').textContent = interim || currentTranscript || 'Listening...';
            };

            recognition.onerror = e => {
                if (e.error === 'not-allowed') {
                    stopListening();
                    document.getElementById('permission-banner').classList.add('show');
                } else if (e.error !== 'no-speech') stopListening();
            };

            recognition.onend = () => { if (isListening) try { recognition.start(); } catch(e) { stopListening(); } };
        }

        function toggleVoice() {
            if (!micPermitted) return requestMicrophonePermission();
            isListening ? stopListening() : startListening();
        }

        function startListening() {
            if (!recognition) return;
            isListening = true;
            currentTranscript = '';
            document.getElementById('mic-button').classList.add('listening');
            document.getElementById('status-text').textContent = 'Listening...';
            try { recognition.start(); } catch(e) { stopListening(); }
        }

        function stopListening() {
            isListening = false;
            if (recognition) recognition.stop();
            document.getElementById('mic-button').classList.remove('listening');
            document.getElementById('status-text').textContent = 'Tap the microphone and say your items. Pause between items. Once you are finished adding items, tap the microphone again to turn it off.\n\nSwipe right to see quick select screens, list and SHOPPING MAN MODE!';
        }

        // Multi-word items that should stay together
        const multiWordItems = {
            'cat food': /\bcat\s+food\b/gi,
            'dog food': /\bdog\s+food\b/gi,
            'half and half': /\bhalf(\s+and\s+half|\s+half)\b/gi,  // Handles "half and half" or "half half"
            'ice cream': /\bice\s+cream\b/gi,
            'peanut butter': /\bpeanut\s+butter\b/gi,
            'orange juice': /\borange\s+juice\b/gi,
            'apple juice': /\bapple\s+juice\b/gi,
            'bouillon cubes': /\b(bouillon|bowling)\s+cubes\b/gi,
            'hot sauce': /\bhot\s+sauce\b/gi,
            'meat': /\bmeet\b/gi  // Fix voice transcription "meet" ‚Üí "meat"
        };

        function processVoice(transcript) {
            // First, protect multi-word items by replacing them with placeholders
            let processed = transcript;
            const replacements = {};
            let placeholderIndex = 0;
            
            Object.entries(multiWordItems).forEach(([item, regex]) => {
                processed = processed.replace(regex, () => {
                    const placeholder = `__ITEM${placeholderIndex}__`;
                    replacements[placeholder] = item;
                    placeholderIndex++;
                    return placeholder;
                });
            });
            
            // Split on common punctuation and natural pauses
            const items = processed.split(/[.,;!?]|\s{2,}/)
                .map(i => {
                    let cleaned = i.trim().replace(/^(and|add|also|plus)\s+/i, '');
                    // Restore multi-word items
                    Object.entries(replacements).forEach(([placeholder, original]) => {
                        cleaned = cleaned.replace(placeholder, original);
                    });
                    return cleaned;
                })
                .filter(i => i.length > 2);
            
            items.forEach(item => {
                if (item.length > 0 && !item.includes('__ITEM')) addItem(item);
            });
            
            if (items.length > 0) currentTranscript = '';
        }

        function addItem(name, silent = false) {
            if (!name) return false;
            const norm = name.toLowerCase().trim();
            
            const deletedIdx = deletedItems.findIndex(i => i.toLowerCase() === norm);
            if (deletedIdx !== -1) {
                deletedItems.splice(deletedIdx, 1);
            }
            
            if (groceryList.some(i => i.toLowerCase() === norm)) {
                if (!silent) showToast(`"${name}" already on list`);
                return false;
            }

            const words = norm.split(' ');
            const similar = groceryList.some(existing => {
                const eWords = existing.toLowerCase().split(' ');
                return words.some(w => w.length > 3 && eWords.some(e => e.includes(w) || w.includes(e)));
            });

            if (similar) {
                const diff = words.some(w => w.length > 3 && !groceryList.some(i => i.toLowerCase().includes(w)));
                if (!diff) {
                    if (!silent) showToast('Similar item already on list');
                    return false;
                }
            }

            groceryList.push(name);
            itemFrequency[norm] = (itemFrequency[norm] || 0) + 1;
            itemOwnership[norm] = deviceId; // Track who added this item
            saveData();
            if (!silent) {
                showToast(`Added: ${name}`);
                playSound('yum');
            }
            updateUI();
            return true;
        }

        function removeItem(idx) {
            playSound('yuck');
            const item = groceryList[idx];
            deletedItems.push(item);
            groceryList.splice(idx, 1);
            saveData();
            showToast(`Removed: ${item}`);
            updateUI();
        }

        function permanentlyDeleteItem(idx) {
            const item = groceryList[idx];
            const norm = item.toLowerCase().trim();
            
            // Track permanent deletion
            permanentDeletions[norm] = (permanentDeletions[norm] || 0) + 1;
            
            // Remove from list
            groceryList.splice(idx, 1);
            
            // Remove from ownership
            delete itemOwnership[norm];
            
            playSound('yuck');
            saveData();
            showToast(`Permanently deleted: ${item}`);
            updateUI();
        }

        function restoreItem(item) {
            deletedItems = deletedItems.filter(i => i.toLowerCase() !== item.toLowerCase());
            groceryList.push(item);
            saveData();
            updateUI();
            showToast(`Restored: ${item}`);
        }

        function updateUI() {
            const activeCount = groceryList.length;
            document.getElementById('item-count').textContent = activeCount;
            updateListDisplay();
            updateQuickAdd();
            updateNavDots();
        }

        function updateListDisplay() {
            const list = document.getElementById('current-list');
            if (groceryList.length === 0 && deletedItems.length === 0) {
                list.innerHTML = '<div class="empty-state">Your list is empty.<br>Add items using voice or quick add!</div>';
            } else {
                let html = '';
                groceryList.forEach((item, i) => {
                    const norm = item.toLowerCase().trim();
                    const isMyItem = itemOwnership[norm] === deviceId;
                    const hasBeenShared = lastSharedTimestamp[norm] !== undefined;
                    
                    // Show both Delete and Remove for your unshared items
                    // Show only Remove for your shared items or others' items
                    if (isMyItem && !hasBeenShared) {
                        html += `<div class="list-item">
                            <span>${item}</span>
                            <div class="button-group">
                                <button class="delete-btn" onclick="permanentlyDeleteItem(${i})">Delete</button>
                                <button class="remove-btn" onclick="removeItem(${i})">Remove</button>
                            </div>
                        </div>`;
                    } else {
                        html += `<div class="list-item">
                            <span>${item}</span>
                            <button class="remove-btn" onclick="removeItem(${i})">Remove</button>
                        </div>`;
                    }
                });
                deletedItems.forEach(item => {
                    html += `<div class="list-item deleted">
                        <span>${item}</span>
                        <button class="remove-btn" onclick="restoreItem('${item.replace(/'/g, "\\'")}')">Restore</button>
                    </div>`;
                });
                list.innerHTML = html;
            }
        }

        function updateQuickAdd() {
            const sixWeeksAgo = Date.now() - (6 * 7 * 24 * 60 * 60 * 1000);
            
            // Filter frequency data to exclude items that were only mistakes
            const sorted = Object.entries(itemFrequency)
                .filter(([item, freq]) => {
                    // Exclude if permanently deleted as many times as added (only mistakes)
                    const permDelCount = permanentDeletions[item] || 0;
                    return freq > permDelCount; // Keep if used successfully at least once
                })
                .sort((a,b) => b[1] - a[1])
                .map(([item]) => item.charAt(0).toUpperCase() + item.slice(1))
                .slice(0, 15);
            
            const items = [...sorted];
            defaultQuickItems.forEach(item => {
                if (items.length >= 20) return;
                if (!items.some(i => i.toLowerCase() === item.toLowerCase())) items.push(item);
            });

            document.getElementById('quick-items').innerHTML = items.slice(0, 20).map((item, i) =>
                `<div class="quick-item"><input type="checkbox" id="q${i}" value="${item}"><label for="q${i}">${item}</label></div>`
            ).join('');
        }

        function addQuickItems() {
            let added = 0;
            document.querySelectorAll('.quick-item input:checked').forEach(cb => {
                if (addItem(cb.value, true)) added++;
                cb.checked = false;
            });
            showToast(added > 0 ? `Added ${added} item(s)` : 'No items selected or already on list');
        }

        function addManualItem() {
            const input = document.getElementById('manual-input');
            if (input.value.trim()) {
                addItem(input.value.trim());
                input.value = '';
            }
        }

        function emailList() {
            if (groceryList.length === 0) return showToast('List is empty!');
            const text = groceryList.map((i, idx) => `${idx+1}. ${i}`).join('\n');
            const subject = `Grocery List - ${new Date().toLocaleDateString()}`;
            const body = `Here's your grocery list:\n\n${text}\n\nGenerated by Grocery List App`;
            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            saveToHistory('emailed');
        }

        function resetList() {
            if (groceryList.length === 0 && deletedItems.length === 0) return showToast('List already empty!');
            if (confirm('Clear all items (including deleted)?')) {
                saveToHistory('reset');
                groceryList = [];
                deletedItems = [];
                shoppingChecked = [];
                saveData();
                updateUI();
                showToast('List reset!');
            }
        }

        function clearOldHistory() {
            const eightWeeksAgo = Date.now() - (8 * 7 * 24 * 60 * 60 * 1000);
            const originalLength = history.length;
            history = history.filter(h => new Date(h.date).getTime() > eightWeeksAgo);
            
            const removed = originalLength - history.length;
            if (removed > 0) {
                saveData();
                showToast(`Cleared ${removed} old history entries`);
                showHistory();
            } else {
                showToast('No history older than 8 weeks');
            }
        }

        function saveToHistory(action) {
            if (groceryList.length === 0 && deletedItems.length === 0) return;
            history.unshift({ 
                date: new Date().toISOString(), 
                action, 
                items: [...groceryList], 
                deleted: [...deletedItems] 
            });
            if (history.length > 20) history = history.slice(0, 20);
            saveData();
        }

        // Shopping Man Mode
        function updateShoppingList() {
            const container = document.getElementById('shopping-list');
            const activeItems = groceryList.filter(item => 
                !deletedItems.some(d => d.toLowerCase() === item.toLowerCase())
            );
            
            if (activeItems.length === 0) {
                container.innerHTML = '<div style="color: white; text-align: center; padding: 40px; font-size: 18px;">No items to shop for! Add some items first.</div>';
                return;
            }
            
            // Group items by category
            const itemsByCategory = {};
            categoryOrder.forEach(cat => itemsByCategory[cat] = []);
            
            activeItems.forEach(item => {
                const category = getCategory(item);
                itemsByCategory[category].push(item);
            });
            
            // Build HTML with category sections
            let html = '';
            categoryOrder.forEach(category => {
                const items = itemsByCategory[category];
                if (items.length === 0) return;
                
                html += `<div class="category-section">
                    <h3 class="category-header">${categoryNames[category]}</h3>`;
                
                items.forEach(item => {
                    const isChecked = shoppingChecked.includes(item);
                    html += `<div class="shopping-item ${isChecked ? 'checked' : ''}">
                        <input type="checkbox" 
                               id="shop-${item.replace(/\s/g, '_')}" 
                               ${isChecked ? 'checked' : ''}
                               onchange="toggleShoppingItem('${item.replace(/'/g, "\\'")}')">
                        <span>${item}</span>
                    </div>`;
                });
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
            updateShoppingProgress();
        }

        function toggleShoppingItem(item) {
            const idx = shoppingChecked.indexOf(item);
            if (idx === -1) {
                shoppingChecked.push(item);
                playSound('swoosh');
            } else {
                shoppingChecked.splice(idx, 1);
            }
            saveData();
            updateShoppingList();
        }

        function updateShoppingProgress() {
            const activeItems = groceryList.filter(item => 
                !deletedItems.some(d => d.toLowerCase() === item.toLowerCase())
            );
            const total = activeItems.length;
            const checked = shoppingChecked.length;
            const percentage = total > 0 ? (checked / total) * 100 : 0;
            
            const progressFill = document.getElementById('shopping-progress');
            progressFill.style.width = percentage + '%';
            progressFill.textContent = `${checked}/${total} items`;
            
            if (checked === total && total > 0) {
                progressFill.style.background = 'linear-gradient(90deg, #FFD700, #FFA500)';
            } else {
                progressFill.style.background = 'linear-gradient(90deg, #4CAF50, #8BC34A)';
            }
        }

        function fulfillFoodDuties() {
            if (shoppingChecked.length === 0) {
                showToast('Check off items as you add them to your cart!');
                return;
            }
            
            const completedParam = encodeURIComponent(JSON.stringify(shoppingChecked));
            const listParam = `&list=${currentListType}`;
            const url = `${window.location.origin}${window.location.pathname}?completed=${completedParam}${listParam}#${currentListType}`;
            
            const listName = currentListType === 'home' ? 'üè† Home' : 'üíº Office';
            const text = `ü¶∏‚Äç‚ôÇÔ∏è Shopping Man Saved the Day!\n\n${listName} - I got: ${shoppingChecked.join(', ')}`;
            
            if (navigator.share) {
                navigator.share({ title: 'Shopping Complete!', text, url })
                    .then(() => {
                        shoppingChecked.forEach(item => {
                            const normItem = item.toLowerCase();
                            const idx = groceryList.findIndex(i => i.toLowerCase() === normItem);
                            if (idx !== -1) {
                                groceryList.splice(idx, 1);
                            }
                        });
                        // BUGFIX: Clear ALL deleted items when shopping completes (including mistakes)
                        deletedItems = [];
                        shoppingChecked = [];
                        saveData();
                        saveToHistory('shopping_completed');
                        showToast('ü¶∏‚Äç‚ôÇÔ∏è Food duties fulfilled! List cleaned up.');
                        updateUI();
                        showScreen('voice-screen');
                    })
                    .catch(() => fallbackShare(url, text));
            } else {
                fallbackShare(url, text);
            }
        }

        function showScreen(id) {
            // Stop microphone if leaving voice screen
            if (isListening && id !== 'voice-screen') {
                stopListening();
            }
            
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (id === 'edit-screen') updateListDisplay();
            else if (id === 'quick-screen') updateQuickAdd();
            else if (id === 'history-screen') showHistory();
            else if (id === 'shopping-screen') updateShoppingList();
            updateNavDots();
        }

        function showHistory() {
            const list = document.getElementById('history-list');
            if (history.length === 0) {
                list.innerHTML = '<div class="empty-state">No past lists yet</div>';
            } else {
                list.innerHTML = history.map(h => {
                    const date = new Date(h.date).toLocaleString();
                    const emoji = h.action === 'emailed' ? 'üìß' : (h.action === 'shared' ? 'üì±' : (h.action === 'shopping_completed' ? 'ü¶∏‚Äç‚ôÇÔ∏è' : 'üîÑ'));
                    const action = h.action === 'emailed' ? 'Emailed' : (h.action === 'shared' ? 'Shared' : (h.action === 'shopping_completed' ? 'Shopping Man!' : 'Reset'));
                    const allItems = [...(h.items || []), ...(h.deleted || []).map(i => `~~${i}~~`)];
                    return `<div class="history-item">
                        <h3>${emoji} ${action}</h3>
                        <p><strong>Date:</strong> ${date}</p>
                        <p><strong>Items (${h.items?.length || 0} active, ${h.deleted?.length || 0} deleted):</strong></p>
                        <ul>${allItems.slice(0,10).map(i => `<li>${i}</li>`).join('')}
                        ${allItems.length > 10 ? `<li><em>...and ${allItems.length-10} more</em></li>` : ''}</ul>
                    </div>`;
                }).join('');
            }
        }

        function updateNavDots() {
            document.querySelectorAll('.dot').forEach((d, i) => {
                const screens = ['voice-screen', 'quick-screen', 'edit-screen', 'shopping-screen'];
                d.classList.toggle('active', document.getElementById(screens[i]).classList.contains('active'));
            });
        }

        function showToast(msg) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Victory Video functions
        function showVictoryVideo(callback) {
            const modal = document.getElementById('victory-modal');
            const video = document.getElementById('victory-video');
            const overlay = document.getElementById('play-overlay');
            const skipButton = document.getElementById('skip-button');
            
            modal.classList.add('show');
            video.currentTime = 0;
            overlay.classList.remove('hidden');
            skipButton.style.display = 'none';
            
            // Store callback for later
            window.victoryCallback = callback;
        }

        function playVictoryVideo() {
            const video = document.getElementById('victory-video');
            const overlay = document.getElementById('play-overlay');
            const skipButton = document.getElementById('skip-button');
            
            // Hide play button overlay
            overlay.classList.add('hidden');
            
            // Show skip button
            skipButton.style.display = 'block';
            
            // Play video with sound
            video.muted = false;
            video.play().catch(() => {
                // If fails, try muted
                video.muted = true;
                video.play();
            });
            
            // Auto-close when video ends
            video.onended = () => {
                closeVictoryVideo();
            };
        }

        function closeVictoryVideo() {
            const modal = document.getElementById('victory-modal');
            const video = document.getElementById('victory-video');
            const overlay = document.getElementById('play-overlay');
            const skipButton = document.getElementById('skip-button');
            
            modal.classList.remove('show');
            video.pause();
            video.currentTime = 0;
            overlay.classList.remove('hidden');
            skipButton.style.display = 'none';
            
            // Call the callback if it exists
            if (window.victoryCallback) {
                window.victoryCallback();
                window.victoryCallback = null;
            }
        }

        let touchX = 0;
        document.addEventListener('touchstart', e => touchX = e.changedTouches[0].screenX);
        document.addEventListener('touchend', e => {
            const diff = touchX - e.changedTouches[0].screenX;
            if (Math.abs(diff) < 50) return;
            const active = document.querySelector('.screen.active').id;
            if (diff > 0) {
                if (active === 'voice-screen') showScreen('quick-screen');
                else if (active === 'quick-screen') showScreen('edit-screen');
                else if (active === 'edit-screen') showScreen('shopping-screen');
            } else {
                if (active === 'shopping-screen') showScreen('edit-screen');
                else if (active === 'edit-screen') showScreen('quick-screen');
                else if (active === 'quick-screen') showScreen('voice-screen');
            }
        });

        document.addEventListener('keypress', e => {
            if (e.target.id === 'manual-input' && e.key === 'Enter') addManualItem();
        });

        // Tutorial System
        let tutorialStep = 1;
        const tutorialSteps = [
            {
                description: "üëã <strong>Welcome!</strong> This app lets two people share a grocery list. Person A starts by adding items he or she needs.",
                phoneA: [
                    { text: "Milk", delay: 500 },
                    { text: "Eggs", delay: 1000 },
                    { text: "Bread", delay: 1500 }
                ],
                phoneB: [],
                showArrow: false,
                phoneABtn: null,
                phoneBBtn: null
            },
            {
                description: "üì± <strong>Share the list!</strong> Person A taps 'Share List' to send it to Person B. The list syncs automatically!",
                phoneA: [
                    { text: "Milk", show: true },
                    { text: "Eggs", show: true },
                    { text: "Bread", show: true }
                ],
                phoneB: [
                    { text: "Milk", delay: 800 },
                    { text: "Eggs", delay: 1100 },
                    { text: "Bread", delay: 1400 }
                ],
                showArrow: true,
                phoneABtn: { text: "üì± Share", class: "share" },
                phoneBBtn: null
            },
            {
                description: "‚úèÔ∏è <strong>Person B edits!</strong> Person B can add new items (Cheese, Apples) and remove items added by Person A (Bread). Person B shares updated list with Person A. Both lists stay synced!",
                phoneA: [
                    { text: "Milk", show: true },
                    { text: "Eggs", show: true },
                    { text: "Bread", show: true, removed: true, delay: 2000 },
                    { text: "Cheese", delay: 2500 },
                    { text: "Apples", delay: 3000 }
                ],
                phoneB: [
                    { text: "Milk", show: true },
                    { text: "Eggs", show: true },
                    { text: "Bread", show: true, removed: true, delay: 2000 },
                    { text: "Cheese", delay: 500 },
                    { text: "Apples", delay: 1000 }
                ],
                showArrow: true,
                phoneABtn: null,
                phoneBBtn: { text: "+ Add Items", class: "" }
            },
            {
                description: "ü¶∏‚Äç‚ôÇÔ∏è <strong>Shopping Man Mode!</strong> When someone goes shopping (and becomes Shopping Man!), that person checks off items and taps 'Fulfilled Food Duties' to notify everyone that Shopping Man Saved the Day!",
                phoneA: [
                    { text: "Milk", show: true },
                    { text: "Eggs", show: true },
                    { text: "Cheese", show: true },
                    { text: "Apples", show: true }
                ],
                phoneB: [
                    { text: "Milk", show: true, checked: true, delay: 500 },
                    { text: "Eggs", show: true, checked: true, delay: 800 },
                    { text: "Cheese", show: true, checked: true, delay: 1100 },
                    { text: "Apples", show: true, checked: true, delay: 1400 }
                ],
                showArrow: false,
                phoneABtn: null,
                phoneBBtn: { text: "ü¶∏‚Äç‚ôÇÔ∏è FULFILLED!", class: "success" },
                celebration: true
            }
        ];

        function openTutorial() {
            tutorialStep = 1;
            document.getElementById('tutorial-modal').classList.add('show');
            renderTutorialStep();
        }

        function closeTutorial() {
            document.getElementById('tutorial-modal').classList.remove('show');
            tutorialStep = 1;
        }

        function tutorialNext() {
            if (tutorialStep < tutorialSteps.length) {
                tutorialStep++;
                renderTutorialStep();
            } else {
                closeTutorial();
            }
        }

        function tutorialPrev() {
            if (tutorialStep > 1) {
                tutorialStep--;
                renderTutorialStep();
            }
        }

        function renderTutorialStep() {
            const step = tutorialSteps[tutorialStep - 1];

            // Update step indicators
            document.querySelectorAll('.step-dot').forEach((dot, idx) => {
                dot.classList.remove('active', 'completed');
                if (idx + 1 === tutorialStep) {
                    dot.classList.add('active');
                } else if (idx + 1 < tutorialStep) {
                    dot.classList.add('completed');
                }
            });

            // Update description
            document.getElementById('tutorial-description').innerHTML = step.description;

            // Update navigation buttons
            document.getElementById('tutorial-prev').disabled = tutorialStep === 1;
            document.getElementById('tutorial-next').textContent = tutorialStep === tutorialSteps.length ? "Got It!" : "Next";

            // Update share arrow
            const arrow = document.getElementById('share-arrow');
            arrow.classList.toggle('show', step.showArrow);

            // Clear and render Phone A
            const phoneAList = document.getElementById('phone-a-list');
            phoneAList.innerHTML = '';
            step.phoneA.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'phone-item';
                div.innerHTML = `<span>${item.text}</span>`;
                if (item.checked) {
                    div.innerHTML = `<span>${item.text}</span><span class="item-check">‚úì</span>`;
                }
                phoneAList.appendChild(div);

                if (item.show) {
                    div.classList.add('show');
                    if (item.removed) {
                        setTimeout(() => div.classList.add('removed'), item.delay || 0);
                    }
                } else {
                    setTimeout(() => {
                        div.classList.add('show');
                        if (item.removed) {
                            setTimeout(() => div.classList.add('removed'), 500);
                        }
                    }, item.delay || 0);
                }
            });

            // Add button to Phone A if specified
            if (step.phoneABtn) {
                const btn = document.createElement('div');
                btn.className = `phone-btn ${step.phoneABtn.class}`;
                btn.textContent = step.phoneABtn.text;
                phoneAList.appendChild(btn);
            }

            // Clear and render Phone B
            const phoneBList = document.getElementById('phone-b-list');
            phoneBList.innerHTML = '';
            step.phoneB.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'phone-item';
                div.innerHTML = `<span>${item.text}</span>`;
                phoneBList.appendChild(div);

                if (item.show) {
                    div.classList.add('show');
                    if (item.removed) {
                        setTimeout(() => div.classList.add('removed'), item.delay || 0);
                    }
                    if (item.checked) {
                        setTimeout(() => {
                            div.classList.add('checked');
                            div.innerHTML = `<span>${item.text}</span><span class="item-check">‚úì</span>`;
                        }, item.delay || 0);
                    }
                } else {
                    setTimeout(() => {
                        div.classList.add('show');
                        if (item.removed) {
                            setTimeout(() => div.classList.add('removed'), 500);
                        }
                    }, item.delay || 0);
                }
            });

            // Add button to Phone B if specified
            if (step.phoneBBtn) {
                const btn = document.createElement('div');
                btn.className = `phone-btn ${step.phoneBBtn.class}`;
                btn.textContent = step.phoneBBtn.text;
                phoneBList.appendChild(btn);
            }

            // Handle celebration overlay
            const celebrationOverlay = document.getElementById('celebration-overlay');
            celebrationOverlay.classList.remove('show');
            if (step.celebration) {
                setTimeout(() => {
                    celebrationOverlay.classList.add('show');
                }, 2000);
            }
        }

        // Close tutorial on escape key
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape' && document.getElementById('tutorial-modal').classList.contains('show')) {
                closeTutorial();
            }
        });

        window.addEventListener('load', init);
    </script>
</body>
</html>
