<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Grocery List</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(to bottom, #f5f5f0, #e8e8e0);
            min-height: 100vh;
        }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; font-size: 28px; }
        .status-text {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 60px 0 30px;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.6;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .mic-button {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 40px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(102,126,234,0.4);
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .mic-button.listening {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .action-buttons { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .btn {
            flex: 1;
            min-width: 120px;
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 600;
        }
        .btn-secondary { background: white; color: #667eea; border: 2px solid #667eea; }
        .btn-share { background: #3498db; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .permission-banner {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        .permission-banner.show { display: block; }
        .permission-banner h3 { color: #856404; margin-bottom: 10px; }
        .permission-banner p { color: #856404; margin-bottom: 10px; }
        .permission-banner button {
            background: #ffc107;
            color: #856404;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }
        .info-banner {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .info-banner h3 { color: #1976d2; margin-bottom: 10px; font-size: 16px; }
        .info-banner p { color: #1976d2; font-size: 14px; }
        .quick-items { display: grid; gap: 12px; margin-top: 20px; }
        .quick-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        .quick-item input { width: 24px; height: 24px; margin-right: 15px; cursor: pointer; }
        .quick-item label { font-size: 18px; color: #2c3e50; cursor: pointer; flex-grow: 1; }
        .list-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .list-item span { font-size: 18px; color: #2c3e50; }
        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }
        .manual-add { display: flex; gap: 10px; margin-bottom: 20px; }
        .manual-add input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        .manual-add button {
            padding: 12px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .empty-state { text-align: center; color: #999; padding: 40px 20px; }
        .history-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .history-item h3 { color: #2c3e50; font-size: 16px; margin-bottom: 8px; }
        .history-item p { color: #777; font-size: 14px; margin-bottom: 6px; }
        .history-item ul { margin-top: 10px; padding-left: 20px; color: #555; }
        .nav-dots {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }
        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            border: 2px solid #667eea;
            cursor: pointer;
        }
        .dot.active { background: #667eea; transform: scale(1.3); }
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideUp 0.3s;
            max-width: 90%;
            text-align: center;
        }
        @keyframes slideUp { from { bottom: 50px; opacity: 0; } to { bottom: 100px; opacity: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="permission-banner" id="permission-banner">
            <h3>ðŸŽ¤ Microphone Access Needed</h3>
            <p>To use voice input, this app needs permission to access your microphone.</p>
            <button onclick="requestMicrophonePermission()">Grant Microphone Access</button>
        </div>

        <div class="info-banner">
            <h3>ðŸ“± How Sharing Works</h3>
            <p>Tap "Share List" to send your items to your wife. She opens the link and items merge automatically!</p>
        </div>

        <div id="voice-screen" class="screen active">
            <h1>ðŸ›’ Grocery List</h1>
            <div class="status-text" id="status-text">
                Tap the microphone and say your items.<br>
                Say "Add" between items.<br>
                Example: "Eggs. Add. Milk. Add. Bread."
            </div>
            <button class="mic-button" id="mic-button" onclick="toggleVoice()">ðŸŽ¤</button>
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="showScreen('edit-screen')">
                    View List (<span id="item-count">0</span>)
                </button>
                <button class="btn btn-share" onclick="shareList()">ðŸ“± Share List</button>
            </div>
        </div>

        <div id="quick-screen" class="screen">
            <h1>Quick Add Items</h1>
            <div class="quick-items" id="quick-items"></div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="addQuickItems()">Add Selected</button>
                <button class="btn btn-secondary" onclick="showScreen('voice-screen')">Back</button>
            </div>
        </div>

        <div id="edit-screen" class="screen">
            <h1>Current List</h1>
            <div class="manual-add">
                <input type="text" id="manual-input" placeholder="Type item name...">
                <button onclick="addManualItem()">Add</button>
            </div>
            <div id="current-list"></div>
            <div class="action-buttons">
                <button class="btn btn-share" onclick="shareList()">ðŸ“± Share</button>
                <button class="btn btn-success" onclick="emailList()">ðŸ“§ Email</button>
                <button class="btn btn-danger" onclick="resetList()">Reset</button>
                <button class="btn btn-secondary" onclick="showScreen('history-screen')">History</button>
                <button class="btn btn-secondary" onclick="showScreen('voice-screen')">Back</button>
            </div>
        </div>

        <div id="history-screen" class="screen">
            <h1>Past Lists</h1>
            <div id="history-list"></div>
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="showScreen('edit-screen')">Back</button>
            </div>
        </div>
    </div>

    <div class="nav-dots">
        <div class="dot active" onclick="showScreen('voice-screen')"></div>
        <div class="dot" onclick="showScreen('quick-screen')"></div>
        <div class="dot" onclick="showScreen('edit-screen')"></div>
    </div>

    <script>
        let groceryList = [];
        let itemFrequency = {};
        let history = [];
        let isListening = false;
        let recognition = null;
        let currentTranscript = '';
        let micPermitted = false;

        const defaultQuickItems = ['Eggs','Milk','Bread','Butter','Cheese','Chicken','Bananas','Apples','Lettuce','Tomatoes','Onions','Potatoes','Rice','Pasta','Coffee'];

        function init() {
            loadData();
            checkMicPermission();
            setupVoiceRecognition();
            updateUI();
            handleIncomingShare();
        }

        function loadData() {
            groceryList = JSON.parse(localStorage.getItem('groceryList') || '[]');
            itemFrequency = JSON.parse(localStorage.getItem('itemFrequency') || '{}');
            history = JSON.parse(localStorage.getItem('groceryHistory') || '[]');
        }

        function saveData() {
            localStorage.setItem('groceryList', JSON.stringify(groceryList));
            localStorage.setItem('itemFrequency', JSON.stringify(itemFrequency));
            localStorage.setItem('groceryHistory', JSON.stringify(history));
        }

        function handleIncomingShare() {
            const params = new URLSearchParams(window.location.search);
            const shared = params.get('items');
            if (shared) {
                try {
                    const items = JSON.parse(decodeURIComponent(shared));
                    let added = 0;
                    items.forEach(item => { if (addItem(item, true)) added++; });
                    if (added > 0) {
                        showToast(`Added ${added} item(s) from shared list!`);
                        updateUI();
                    }
                    window.history.replaceState({}, '', window.location.pathname);
                } catch (e) { console.error(e); }
            }
        }

        function shareList() {
            if (groceryList.length === 0) return showToast('List is empty!');
            const url = `${window.location.origin}${window.location.pathname}?items=${encodeURIComponent(JSON.stringify(groceryList))}`;
            const text = `My grocery list: ${groceryList.join(', ')}`;
            
            if (navigator.share) {
                navigator.share({ title: 'Grocery List', text, url })
                    .then(() => { saveToHistory('shared'); showToast('Shared!'); })
                    .catch(() => fallbackShare(url, text));
            } else {
                fallbackShare(url, text);
            }
        }

        function fallbackShare(url, text) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(`${text}\n\n${url}`)
                    .then(() => showToast('Link copied! Paste in a text message.'));
            } else {
                alert(`Share this link:\n\n${url}`);
            }
        }

        async function checkMicPermission() {
            try {
                if (navigator.permissions) {
                    const result = await navigator.permissions.query({ name: 'microphone' });
                    micPermitted = result.state === 'granted';
                    document.getElementById('permission-banner').classList.toggle('show', !micPermitted);
                } else {
                    document.getElementById('permission-banner').classList.add('show');
                }
            } catch (e) {
                document.getElementById('permission-banner').classList.add('show');
            }
        }

        async function requestMicrophonePermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(t => t.stop());
                micPermitted = true;
                document.getElementById('permission-banner').classList.remove('show');
                showToast('Microphone granted!');
            } catch (e) {
                alert('Microphone access required.\n\n1. Tap lock icon in address bar\n2. Allow microphone\n3. Reload page');
            }
        }

        function setupVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return;
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SR();
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onresult = e => {
                let interim = '', final = '';
                for (let i = e.resultIndex; i < e.results.length; i++) {
                    const transcript = e.results[i][0].transcript;
                    if (e.results[i].isFinal) final += transcript + ' ';
                    else interim += transcript;
                }
                if (final) {
                    currentTranscript += final;
                    processVoice(currentTranscript);
                }
                document.getElementById('status-text').textContent = interim || currentTranscript || 'Listening...';
            };

            recognition.onerror = e => {
                if (e.error === 'not-allowed') {
                    stopListening();
                    document.getElementById('permission-banner').classList.add('show');
                } else if (e.error !== 'no-speech') stopListening();
            };

            recognition.onend = () => { if (isListening) try { recognition.start(); } catch(e) { stopListening(); } };
        }

        function toggleVoice() {
            if (!micPermitted) return requestMicrophonePermission();
            isListening ? stopListening() : startListening();
        }

        function startListening() {
            if (!recognition) return;
            isListening = true;
            currentTranscript = '';
            document.getElementById('mic-button').classList.add('listening');
            document.getElementById('status-text').textContent = 'Listening...';
            try { recognition.start(); } catch(e) { stopListening(); }
        }

        function stopListening() {
            isListening = false;
            if (recognition) recognition.stop();
            document.getElementById('mic-button').classList.remove('listening');
            document.getElementById('status-text').textContent = 'Tap the microphone and say your items.\\nSay "Add" between items.\\nExample: "Eggs. Add. Milk. Add. Bread."';
        }

        function processVoice(transcript) {
            const items = transcript.split(/\\s+add\\s+/i)
                .map(i => i.trim().replace(/[.,!?]/g, ''))
                .filter(i => i.length > 0);
            items.forEach(addItem);
            if (items.length > 0) currentTranscript = '';
        }

        function addItem(name, silent = false) {
            if (!name) return false;
            const norm = name.toLowerCase().trim();
            
            if (groceryList.some(i => i.toLowerCase() === norm)) {
                if (!silent) showToast(`"${name}" already on list`);
                return false;
            }

            const words = norm.split(' ');
            const similar = groceryList.some(existing => {
                const eWords = existing.toLowerCase().split(' ');
                return words.some(w => w.length > 3 && eWords.some(e => e.includes(w) || w.includes(e)));
            });

            if (similar) {
                const diff = words.some(w => w.length > 3 && !groceryList.some(i => i.toLowerCase().includes(w)));
                if (!diff) {
                    if (!silent) showToast('Similar item already on list');
                    return false;
                }
            }

            groceryList.push(name);
            itemFrequency[norm] = (itemFrequency[norm] || 0) + 1;
            saveData();
            if (!silent) showToast(`Added: ${name}`);
            updateUI();
            return true;
        }

        function removeItem(idx) {
            const item = groceryList[idx];
            groceryList.splice(idx, 1);
            saveData();
            showToast(`Removed: ${item}`);
            updateUI();
        }

        function updateUI() {
            document.getElementById('item-count').textContent = groceryList.length;
            updateListDisplay();
            updateQuickAdd();
            updateNavDots();
        }

        function updateListDisplay() {
            const list = document.getElementById('current-list');
            if (groceryList.length === 0) {
                list.innerHTML = '<div class="empty-state">Your list is empty.<br>Add items using voice or quick add!</div>';
            } else {
                list.innerHTML = groceryList.map((item, i) => 
                    `<div class="list-item"><span>${item}</span><button class="delete-btn" onclick="removeItem(${i})">Remove</button></div>`
                ).join('');
            }
        }

        function updateQuickAdd() {
            const sorted = Object.entries(itemFrequency)
                .sort((a,b) => b[1] - a[1])
                .map(([item]) => item.charAt(0).toUpperCase() + item.slice(1))
                .slice(0, 15);
            
            const items = [...sorted];
            defaultQuickItems.forEach(item => {
                if (items.length >= 20) return;
                if (!items.some(i => i.toLowerCase() === item.toLowerCase())) items.push(item);
            });

            document.getElementById('quick-items').innerHTML = items.slice(0, 20).map((item, i) =>
                `<div class="quick-item"><input type="checkbox" id="q${i}" value="${item}"><label for="q${i}">${item}</label></div>`
            ).join('');
        }

        function addQuickItems() {
            let added = 0;
            document.querySelectorAll('.quick-item input:checked').forEach(cb => {
                if (addItem(cb.value, true)) added++;
                cb.checked = false;
            });
            showToast(added > 0 ? `Added ${added} item(s)` : 'No items selected or already on list');
        }

        function addManualItem() {
            const input = document.getElementById('manual-input');
            if (input.value.trim()) {
                addItem(input.value.trim());
                input.value = '';
            }
        }

        function emailList() {
            if (groceryList.length === 0) return showToast('List is empty!');
            const text = groceryList.map((i, idx) => `${idx+1}. ${i}`).join('\\n');
            const subject = `Grocery List - ${new Date().toLocaleDateString()}`;
            const body = `Here's your grocery list:\\n\\n${text}\\n\\nGenerated by Grocery List App`;
            window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            saveToHistory('emailed');
        }

        function resetList() {
            if (groceryList.length === 0) return showToast('List already empty!');
            if (confirm('Clear all items?')) {
                saveToHistory('reset');
                groceryList = [];
                saveData();
                updateUI();
                showToast('List reset!');
            }
        }

        function saveToHistory(action) {
            if (groceryList.length === 0) return;
            history.unshift({ date: new Date().toISOString(), action, items: [...groceryList] });
            if (history.length > 20) history = history.slice(0, 20);
            saveData();
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (id === 'edit-screen') updateListDisplay();
            else if (id === 'quick-screen') updateQuickAdd();
            else if (id === 'history-screen') showHistory();
            updateNavDots();
        }

        function showHistory() {
            const list = document.getElementById('history-list');
            if (history.length === 0) {
                list.innerHTML = '<div class="empty-state">No past lists yet</div>';
            } else {
                list.innerHTML = history.map(h => {
                    const date = new Date(h.date).toLocaleString();
                    const emoji = h.action === 'emailed' ? 'ðŸ“§' : (h.action === 'shared' ? 'ðŸ“±' : 'ðŸ”„');
                    const action = h.action === 'emailed' ? 'Emailed' : (h.action === 'shared' ? 'Shared' : 'Reset');
                    return `<div class="history-item">
                        <h3>${emoji} ${action}</h3>
                        <p><strong>Date:</strong> ${date}</p>
                        <p><strong>Items (${h.items.length}):</strong></p>
                        <ul>${h.items.slice(0,10).map(i => `<li>${i}</li>`).join('')}
                        ${h.items.length > 10 ? `<li><em>...and ${h.items.length-10} more</em></li>` : ''}</ul>
                    </div>`;
                }).join('');
            }
        }

        function updateNavDots() {
            document.querySelectorAll('.dot').forEach((d, i) => {
                const screens = ['voice-screen', 'quick-screen', 'edit-screen'];
                d.classList.toggle('active', document.getElementById(screens[i]).classList.contains('active'));
            });
        }

        function showToast(msg) {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        let touchX = 0;
        document.addEventListener('touchstart', e => touchX = e.changedTouches[0].screenX);
        document.addEventListener('touchend', e => {
            const diff = touchX - e.changedTouches[0].screenX;
            if (Math.abs(diff) < 50) return;
            const active = document.querySelector('.screen.active').id;
            if (diff > 0) {
                if (active === 'voice-screen') showScreen('quick-screen');
                else if (active === 'quick-screen') showScreen('edit-screen');
            } else {
                if (active === 'edit-screen') showScreen('quick-screen');
                else if (active === 'quick-screen') showScreen('voice-screen');
            }
        });

        document.addEventListener('keypress', e => {
            if (e.target.id === 'manual-input' && e.key === 'Enter') addManualItem();
        });

        window.addEventListener('load', init);
    </script>
</body>
</html>
